# 設計書

## 概要

この設計は、クロスプラットフォーム互換性の修正、全プラットフォームをサポートするテストケースの更新、エラーハンドリングの改善により、GitHub Actionsの失敗を解決します。ソリューションは3つの主要領域に焦点を当てています：プラットフォーム固有のファイルロック、包括的なテストカバレッジ、堅牢なCI/CDパイプライン設定。

## アーキテクチャ

### クロスプラットフォームファイルロック戦略

現在の実装はUnix固有の`fcntl`モジュールを使用しており、Windowsでは利用できません。プラットフォーム対応のファイルロック機構を実装する必要があります：

```
ProcessLock
├── Unix実装 (fcntl)
├── Windows実装 (msvcrt)
└── フォールバック実装 (ファイルベース)
```

### プラットフォーム検出の拡張

既存のプラットフォーム検出を拡張して、テストシナリオでmacOSを含む全てのサポートされているプラットフォームを適切に処理します。

### テストフレームワークの改善

テストケースをプラットフォーム対応に更新し、プラットフォーム固有機能の適切なモックを含めます。

## コンポーネントとインターフェース

### 1. 拡張ProcessLockクラス

**場所**: `src/setup_repo/utils.py`

**変更点**:
- プラットフォーム固有モジュールの条件付きインポートを追加
- `msvcrt`を使用したWindows互換ファイルロックを実装
- サポートされていないプラットフォーム用のフォールバック機構を追加
- 既存のUnix実装との後方互換性を維持

**インターフェース**:
```python
class ProcessLock:
    def __init__(self, lock_file_path: str)
    def acquire_lock(self) -> bool
    def release_lock(self) -> None
    def _get_lock_implementation(self) -> LockImplementation
```

### 2. プラットフォーム固有ロック実装

**Unixロック実装**:
- ファイルロックに`fcntl.flock()`を使用
- `OSError`と`IOError`例外を処理

**Windowsロック実装**:
- ファイルロックに`msvcrt.locking()`を使用
- Windows固有の例外を処理

**フォールバック実装**:
- 基本的なロック機構としてファイル存在チェックを使用
- プラットフォーム固有のロックが利用できない場合に最小限の機能を提供

### 3. 更新されたテストケース

**プラットフォーム検出テスト**:
- 有効なプラットフォームリストに`macos`を含める
- プラットフォーム固有のテストシナリオを追加
- 一貫したテストのためのプラットフォーム検出をモック

**ログ設定テスト**:
- プラットフォーム固有のパス差異を処理
- 環境変数を適切にモック
- UnixとWindowsの両方のパス形式をテスト

**クロスプラットフォーム統合テスト**:
- 全プラットフォームでファイルロックをテスト
- 機能が利用できない場合の適切な劣化を検証
- プラットフォーム間での一貫した動作を保証

## データモデル

### ロック実装インターフェース

```python
from abc import ABC, abstractmethod

class LockImplementation(ABC):
    @abstractmethod
    def acquire(self, file_handle) -> bool:
        pass

    @abstractmethod
    def release(self, file_handle) -> None:
        pass

    @abstractmethod
    def is_available(self) -> bool:
        pass
```

### プラットフォーム設定

```python
@dataclass
class PlatformConfig:
    name: str
    lock_implementation: Type[LockImplementation]
    path_separator: str
    supports_fcntl: bool
    supports_msvcrt: bool
```

## エラーハンドリング

### インポートエラーハンドリング

```python
try:
    import fcntl
    FCNTL_AVAILABLE = True
except ImportError:
    FCNTL_AVAILABLE = False

try:
    import msvcrt
    MSVCRT_AVAILABLE = True
except ImportError:
    MSVCRT_AVAILABLE = False
```

### ロック取得失敗

- 優先ロック機構が失敗した場合に警告をログ
- 代替実装に自動的にフォールバック
- デバッグ用の明確なエラーメッセージを提供

### プラットフォーム検出失敗

- プラットフォームが判定できない場合は'linux'をデフォルトに
- デバッグ用にプラットフォーム検出結果をログ
- CI環境でのエッジケースを処理

## テスト戦略

### ユニットテスト

1. **プラットフォーム固有モック**:
   - 異なるプラットフォームをテストするために`platform.system()`をモック
   - モジュール可用性（`fcntl`、`msvcrt`）をモック
   - エラー条件とフォールバック機構をテスト

2. **クロスプラットフォームテストマトリックス**:
   - 各ロック実装を独立してテスト
   - シミュレートされたWindows/Unix環境での動作を検証
   - 適切な劣化シナリオをテスト

3. **統合テスト**:
   - 異なるプラットフォーム設定でProcessLockをテスト
   - 並行シナリオでファイルロックが動作することを検証
   - クリーンアップとエラー回復をテスト

### CI/CDテスト

1. **プラットフォームマトリックステスト**:
   - Windows、macOS、Linuxでテストを実行
   - プラットフォーム固有のコードパスを検証
   - 各プラットフォームで実際のファイルロック動作をテスト

2. **エラーシナリオテスト**:
   - ロックモジュールが利用できない場合の動作をテスト
   - 権限エラーの適切な処理を検証
   - ロックファイル破損からの回復をテスト

## 実装計画

### フェーズ1: コアプラットフォーム互換性

1. 条件付きインポートで`utils.py`を更新
2. Windows互換ファイルロックを実装
3. フォールバックロック機構を追加
4. ProcessLockクラスインターフェースを更新

### フェーズ2: テストフレームワーク更新

1. macOSを含むようにプラットフォーム検出テストを更新
2. クロスプラットフォームパス用のログ設定テストを修正
3. 包括的なプラットフォーム固有テストケースを追加
4. テストモック戦略を更新

### フェーズ3: CI/CDパイプライン修正

1. 必要に応じてGitHub Actionsワークフローを更新
2. 全プラットフォームでのテスト実行を検証
3. プラットフォーム固有エラー報告を追加
4. エンドツーエンド機能を検証

## 後方互換性

- 既存のProcessLock使用は変更なし
- Unixシステムは引き続きfcntl実装を使用
- パブリックAPIに破壊的変更なし
- 適切な劣化により基本機能を維持

## パフォーマンス考慮事項

- プラットフォーム検出はインポート時に一度実行
- ロック実装選択はキャッシュされる
- プラットフォーム固有コードパスの最小オーバーヘッド
- フォールバック機構は許容可能なパフォーマンス特性を持つ

## セキュリティ考慮事項

- ファイルロックはプロセスレベルの同期を提供
- ロックファイルは適切な権限で作成される
- クリーンアップ機構によりロックファイルの蓄積を防止
- エラーハンドリングは機密情報を露出しない
