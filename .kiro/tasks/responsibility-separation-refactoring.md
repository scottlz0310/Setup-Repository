# 責任分離リファクタリング計画

## 📋 概要
Setup-Repositoryプロジェクトの責任分離を改善し、保守性と可読性を向上させる。

## 🎯 目標
- 責任の重複を解消
- 大きすぎるモジュールを適切に分割
- 単一責任原則の徹底
- テストカバレッジの維持

## 📊 現状分析
- **責任重複**: 4件
- **大きなモジュール**: 5件（8関数以上）
- **循環依存**: なし ✅
- **結合度**: 適切 ✅

## 🔧 リファクタリングタスク

### Phase 1: 重複解消（優先度: 高）

#### Task 1.1: `detect_platform()`重複解消
**影響範囲**: `utils.py`, `platform_detector.py`
**工数**: 0.5日

**作業内容**:
1. `utils.py`の`detect_platform()`を削除
2. 全ての呼び出し箇所を`platform_detector.detect_platform()`に変更
3. インポート文を更新

**変更ファイル**:
- `src/setup_repo/utils.py` (削除)
- `src/setup_repo/sync.py` (インポート変更)
- その他の呼び出し箇所

#### Task 1.2: `ensure_uv()`重複解消
**影響範囲**: `python_env.py`, `uv_installer.py`
**工数**: 0.5日

**作業内容**:
1. `python_env.py`の`ensure_uv()`を削除
2. `uv_installer.ensure_uv()`への統一
3. 依存関係の更新

#### Task 1.3: `save_error_report()`重複解消
**影響範囲**: `ci_error_handler.py`, `quality_logger.py`
**工数**: 1日

**作業内容**:
1. 機能の差分を分析
2. 統一インターフェースの設計
3. 重複コードの削除

### Phase 2: モジュール分割（優先度: 中）

#### Task 2.1: `quality_logger.py`分割
**現状**: 19関数
**工数**: 2日

**分割案**:
```
quality_logger.py (8関数)
├── 基本ログ機能
├── ログ設定
└── メイン API

quality_errors.py (6関数)
├── エラークラス定義
├── エラーハンドリング
└── 例外処理

quality_formatters.py (5関数)
├── ログフォーマッター
├── 出力形式
└── 色付け機能
```

#### Task 2.2: `ci_error_handler.py`分割
**現状**: 11関数
**工数**: 1.5日

**分割案**:
```
ci_environment.py (5関数)
├── CI環境検出
├── システム情報収集
└── 環境変数処理

ci_error_handler.py (6関数)
├── エラーハンドリング
├── レポート生成
└── 通知機能
```

#### Task 2.3: `logging_config.py`分割
**現状**: 11関数
**工数**: 1日

**分割案**:
```
logging_config.py (6関数)
├── 基本設定
├── 環境別設定
└── メイン API

logging_handlers.py (5関数)
├── カスタムハンドラー
├── フィルター
└── フォーマッター
```

#### Task 2.4: `quality_metrics.py`分割
**現状**: 11関数
**工数**: 1.5日

**分割案**:
```
quality_metrics.py (6関数)
├── メトリクス収集
├── スコア計算
└── メイン API

quality_collectors.py (5関数)
├── 個別ツール連携
├── データ収集
└── 結果パース
```

#### Task 2.5: `interactive_setup.py`分割
**現状**: 10関数
**工数**: 1日

**分割案**:
```
interactive_setup.py (6関数)
├── メインウィザード
├── フロー制御
└── ユーザー入力

setup_validators.py (4関数)
├── 入力検証
├── 前提条件チェック
└── 設定検証
```

### Phase 3: テスト更新（優先度: 高）

#### Task 3.1: 分割されたモジュールのテスト作成
**工数**: 2日

**作業内容**:
1. 新しいモジュール用のテストファイル作成
2. 既存テストの分割・移動
3. カバレッジの維持確認

#### Task 3.2: 統合テストの更新
**工数**: 1日

**作業内容**:
1. インポートパスの更新
2. モックオブジェクトの調整
3. テスト実行の確認

## 📅 実行スケジュール

### Week 1: Phase 1 (重複解消)
- Day 1-2: Task 1.1, 1.2
- Day 3-4: Task 1.3
- Day 5: テスト・検証

### Week 2: Phase 2 (モジュール分割)
- Day 1-2: Task 2.1
- Day 3: Task 2.2
- Day 4: Task 2.3
- Day 5: Task 2.4, 2.5

### Week 3: Phase 3 (テスト更新)
- Day 1-2: Task 3.1
- Day 3: Task 3.2
- Day 4-5: 統合テスト・品質チェック

**総工数**: 12日 (リファクタリング) + 11日 (テスト) = **23日**

## 📊 テストカバレッジ向上

**現状**: 66.18% → **目標**: 80%

詳細は `coverage-improvement-plan.md` を参照

### Phase 4: テストカバレッジ向上 (Week 4-6)
- Week 4: 低・中カバレッジ改善 (75%目標)
- Week 5: 統合テスト・最適化 (80%目標)
- Week 6: 品質向上・最終調整 (85%目標)

## 🧪 品質保証

### 必須チェック項目
- [ ] 全テストが通過
- [ ] カバレッジ80%以上達成 (現在: 4.86%)
- [ ] 全モジュール60%以上カバー
- [ ] 重要モジュール80%以上カバー
- [ ] Ruffリンティング通過
- [ ] BasedPyright型チェック通過
- [ ] 既存APIの後方互換性維持
- [ ] テスト実行時間5分以内

### 検証手順
1. 各Phase完了後にCI/CDパイプライン実行
2. 品質メトリクス収集・比較
3. パフォーマンステスト実行
4. ドキュメント更新

## 🚨 リスク管理

### 高リスク
- **API変更による破壊的変更**
  - 対策: 段階的移行、deprecation警告

### 中リスク
- **テストの複雑化**
  - 対策: モック戦略の統一

### 低リスク
- **一時的なコード重複**
  - 対策: Phase完了後の清掃

## 📝 成果物

### コード
- リファクタリング済みモジュール
- 包括的テストスイート (80%カバレッジ)
- 移行ガイド
- カバレッジ監視スクリプト

### ドキュメント
- アーキテクチャ更新
- API変更ログ
- 開発者向けガイド
- テスト戦略ドキュメント

## ✅ 完了基準

1. **機能**: 既存機能の完全な動作
2. **品質**: 全品質ゲート通過
3. **保守性**: 責任分離の改善確認
4. **文書**: 更新されたドキュメント

## 🔄 継続的改善

リファクタリング完了後:
- 月次の責任分離レビュー
- 新機能追加時の設計レビュー
- 品質メトリクスの継続監視
