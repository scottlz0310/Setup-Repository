# ADR-001: プロジェクトアーキテクチャ設計

## ステータス
承認済み

## 日付
2025-09-18

## コンテキスト
Setup-Repositoryプロジェクトの基本アーキテクチャを定義する必要がある。クロスプラットフォーム対応、保守性、拡張性を重視した設計が求められる。

## 決定事項

### 1. モジュラーアーキテクチャ採用
- 単一責務原則に基づく機能分離
- 疎結合な設計による保守性向上
- プラットフォーム固有処理の分離

### 2. レイヤー構造
```
src/setup_repo/
├── cli.py              # CLI インターフェース
├── config.py           # 設定管理
├── platform_detector.py # プラットフォーム検出
├── git_operations.py   # Git操作
├── github_api.py       # GitHub API
├── quality_*.py        # 品質管理モジュール群
├── security_*.py       # セキュリティモジュール群
└── utils.py           # 共通ユーティリティ
```

### 3. 依存関係管理
- uvを標準パッケージマネージャーとして採用
- pyproject.tomlによる統合設定管理
- 最小限の外部依存関係

### 4. エラーハンドリング戦略
- ドメイン固有例外の定義
- 構造化ログによる問題追跡
- 適切なフォールバック機構

### 5. テスト戦略
- 実環境重視のテスト設計
- プラットフォーム固有テストの分離
- 外部依存のモック化（最小限）

## 理由

### モジュラー設計の採用理由
- **保守性**: 機能ごとの独立した開発・テストが可能
- **拡張性**: 新機能追加時の影響範囲を限定
- **テスタビリティ**: 単体テストの作成が容易

### uv採用理由
- **高速性**: Rustベースの高速パッケージ管理
- **一貫性**: ロックファイルによる再現可能なビルド
- **モダン性**: 最新のPythonパッケージング標準に準拠

### 実環境重視テストの採用理由
- **信頼性**: 実際の動作環境での検証
- **プラットフォーム差異の検出**: 各OS固有の問題を早期発見
- **ユーザー体験の向上**: 実際の使用状況に近いテスト

## 影響

### ポジティブな影響
- 高い保守性と拡張性
- プラットフォーム間の一貫した動作
- 開発者体験の向上
- 品質の向上

### 考慮すべき影響
- 初期開発コストの増加
- アーキテクチャ理解の学習コスト
- テスト実行時間の増加（実環境テストのため）

## 代替案

### 1. モノリシック設計
- **却下理由**: 保守性・拡張性の問題
- **メリット**: 初期開発の簡素化
- **デメリット**: 長期的な保守コスト増大

### 2. pip/poetry使用
- **却下理由**: パフォーマンスと一貫性の問題
- **メリット**: 既存ツールとの親和性
- **デメリット**: 依存関係解決の遅さ

### 3. モック中心のテスト
- **却下理由**: 実環境での動作保証が困難
- **メリット**: テスト実行の高速化
- **デメリット**: プラットフォーム固有問題の見落とし

## 実装ガイドライン

### 1. モジュール設計原則
- 各モジュールは単一の責務を持つ
- 公開APIは最小限に抑える
- 内部実装の詳細を隠蔽する

### 2. エラーハンドリング
```python
class SetupRepoError(Exception):
    """基底例外クラス"""
    pass

class PlatformDetectionError(SetupRepoError):
    """プラットフォーム検出エラー"""
    pass
```

### 3. ログ設計
```python
import logging
import json

logger = logging.getLogger(__name__)

def log_structured(event: str, **kwargs):
    """構造化ログ出力"""
    log_data = {
        "event": event,
        "timestamp": datetime.utcnow().isoformat(),
        **kwargs
    }
    logger.info(json.dumps(log_data))
```

### 4. 設定管理
```python
from pathlib import Path
from typing import Dict, Any

class Config:
    """設定管理クラス"""

    def __init__(self, config_path: Path):
        self.config_path = config_path
        self._config: Dict[str, Any] = {}

    def load(self) -> None:
        """設定ファイル読み込み"""
        # 実装詳細
        pass
```

## 関連文書
- [プロジェクトルール](../../.amazonq/rules/rules.md)
- [テスト戦略](../testing-strategy.md)
- [セキュリティ設計](../security-fix-plan.md)

## 更新履歴
- 2025-09-18: 初版作成
- 次回レビュー予定: 2026-03-18
