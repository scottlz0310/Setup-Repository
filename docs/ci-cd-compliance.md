# CI/CD パイプライン ルール準拠ドキュメント

## 概要

本ドキュメントは、Setup-RepositoryプロジェクトのCI/CDパイプラインが[AI開発標準ルール](../.amazonq/rules/rules.md)の第5章（テスト戦略）および第7章（CI/CD要件）に準拠していることを説明します。

## ルール5章（テスト戦略）準拠状況

### 5.1 構成 ✅
- **フレームワーク**: pytest使用
- **配置**: tests/ディレクトリ配下、test_*.py形式
- **カバレッジ測定**: pytest-covによるCI ゲート化実装

### 5.2 カバレッジ目標 ✅
- **production段階**: 80%以上を必須設定
- **CI閾値**: `--cov-fail-under=80`で未達時ブロック
- **品質ゲート**: 専用ワークフロー`quality-gate.yml`で実装

### 5.3 段階別方針 ✅
```
production段階（現在）:
  - E2E/パフォーマンステスト実装
  - mypy strict相当設定
  - カバレッジ80%以上必須
```

### 5.4 絶対ルール ✅
- **禁止事項**: 条件緩和/ダミーテスト/無意味テストを排除
- **必須事項**: 実際のバグ検出能力のあるテスト実装
- **エラー処理**: 根本解決まで継続する方針

### 5.5 テストデータと再現性 ✅
- **並列実行**: `--dist=worksteal`で再現性向上
- **固定化**: seed固定、UTC時刻使用
- **安定化**: 並び順・ロケール固定

### 5.7 Mock戦略 ✅
- **実環境優先**: プラットフォーム依存テストは実環境で実行
- **適切なSKIP**: 実環境に合わないテストはSKIP処理
- **最小限Mock**: 外部依存・破壊的変更・非決定的挙動のみ

## ルール7章（CI/CD要件）準拠状況

### 7.1 マトリクス・キャッシュ ✅
- **OSマトリクス**: Windows/Linux/macOS
- **Pythonバージョン**: 3.11/3.12/3.13（直近LTSと最新安定版）
- **キャッシュキー**: `pyproject.toml`と`uv.lock`を含む

### 7.2 必須チェック ✅
- **依存再現性**: `uv sync`による検証
- **lint**: ruff実行
- **type**: mypy実行
- **test+cov**: 80%以上閾値
- **セキュリティスキャン**: CodeQL/SCA/Secret scan/SBOM
- **秘密情報検出**: TruffleHog + 基本パターン検出

### 7.3 デプロイ・環境保護 ✅
- **権限設定**: permissions最小化（read標準、必要時write限定）
- **Branch Protection**: 必須チェック、force-push禁止設定
- **承認ゲート**: 環境別承認フロー

### 7.4 失敗時通知 ✅
- **自動通知**: GitHub通知自動化
- **アーティファクト**: エラーレポート自動アップロード
- **MTTA/MTTR**: 短縮を図る設計

## 実装されたワークフロー

### 1. メインCI/CDパイプライン (`ci.yml`)
- **トリガー**: push/PR/手動実行
- **マトリクス**: Python 3.11-3.13 × Ubuntu
- **品質チェック**: lint/format/type/test+cov
- **クロスプラットフォーム**: Windows/Linux/macOS対応
- **セキュリティ**: 統合セキュリティスキャン

### 2. 拡張マトリクステスト (`ci-matrix.yml`)
- **スケジュール**: 毎日午前2時（UTC）
- **包括的テスト**: 全OS×全Pythonバージョン
- **パフォーマンス**: ベンチマーク測定

### 3. セキュリティスキャン (`security.yml`)
- **依存関係レビュー**: Dependabot統合
- **脆弱性スキャン**: Safety + Bandit
- **CodeQL分析**: GitHub Advanced Security
- **シークレット検出**: TruffleHog
- **ライセンス監査**: pip-licenses

### 4. 品質ゲート (`quality-gate.yml`)
- **PR専用**: プルリクエスト時の品質チェック
- **必須項目**: ルール7.2の全項目実装
- **閾値管理**: 80%カバレッジ必須

## 設定ファイル更新

### pyproject.toml
```toml
requires-python = ">=3.11"  # ルール3.2準拠
target-version = "py311"    # ruff設定更新
fail_under = 80            # production段階要件
```

### pytest設定
```toml
addopts = "--cov-fail-under=80 --dist=worksteal"  # 再現性向上
```

## 品質メトリクス

- **カバレッジ**: 80%以上必須（production段階）
- **型チェック**: mypy strict相当
- **セキュリティ**: 高リスク脆弱性0件
- **依存関係**: 既知脆弱性0件
- **ライセンス**: 禁止ライセンス0件

## 継続的改善

1. **定期レビュー**: 月次品質レビューワークフロー
2. **メトリクス収集**: 品質トレンド分析
3. **自動更新**: Dependabot自動マージ
4. **パフォーマンス監視**: ベンチマーク回帰検出

## 結論

Setup-RepositoryプロジェクトのCI/CDパイプラインは、AI開発標準ルールの第5章および第7章の要件を完全に満たしています。production段階の品質要件（カバレッジ80%以上、包括的セキュリティチェック、依存関係再現性）を実装し、継続的な品質向上を実現しています。
