name: Dependabot Auto-merge

run-name: "Dependabot Auto-merge - ${{ github.event_name == 'pull_request' && format('PR #{0}', github.event.number) || 'Check' }}"

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read

env:
  PYTHON_VERSION: "3.11"

jobs:
  dependabot-auto-merge:
    name: Dependabot Auto-merge
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Analyze update type and security impact
        id: security-check
        run: |
          echo "=== Dependabotæ›´æ–°åˆ†æ ==="
          echo "ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}"
          echo "æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}"
          echo "ã‚¢ãƒ©ãƒ¼ãƒˆçŠ¶æ…‹: ${{ steps.metadata.outputs.alert-state }}"

          is_security_update=false
          auto_merge_eligible=false

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã®åˆ¤å®š
          if [[ "${{ steps.metadata.outputs.alert-state }}" == "OPEN" ]] || \
             [[ "${{ steps.metadata.outputs.alert-state }}" == "FIXED" ]]; then
            is_security_update=true
            echo "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          fi

          # æ›´æ–°ã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹è‡ªå‹•ãƒãƒ¼ã‚¸åˆ¤å®š
          case "${{ steps.metadata.outputs.update-type }}" in
            "version-update:semver-patch"|"version-update:semver-minor")
              auto_merge_eligible=true
              echo "âœ… ãƒ‘ãƒƒãƒ/ãƒã‚¤ãƒŠãƒ¼æ›´æ–°: è‡ªå‹•ãƒãƒ¼ã‚¸å¯¾è±¡"
              ;;
            "version-update:semver-major")
              auto_merge_eligible=false
              echo "âš ï¸ ãƒ¡ã‚¸ãƒ£ãƒ¼æ›´æ–°: æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦"
              ;;
          esac

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã¯å„ªå…ˆçš„ã«è‡ªå‹•ãƒãƒ¼ã‚¸
          if [[ "$is_security_update" == "true" ]]; then
            auto_merge_eligible=true
            echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã®ãŸã‚è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’æœ‰åŠ¹åŒ–"
          fi

          echo "is-security=$is_security_update" >> $GITHUB_OUTPUT
          echo "auto-merge=$auto_merge_eligible" >> $GITHUB_OUTPUT

      - name: Setup UV environment for testing
        if: steps.security-check.outputs.auto-merge == 'true'
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
          uv python install ${{ env.PYTHON_VERSION }}
          uv venv --python ${{ env.PYTHON_VERSION }}
          uv sync --dev

      - name: Run compatibility tests
        if: steps.security-check.outputs.auto-merge == 'true'
        run: |
          echo "=== ä¾å­˜é–¢ä¿‚äº’æ›æ€§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ==="
          export PATH="$HOME/.cargo/bin:$PATH"

          uv run python -c "
          import sys
          try:
              import setup_repo
              print('âœ… setup_repo ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ')
          except ImportError as e:
              print(f'âŒ setup_repo ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: {e}')
              sys.exit(1)
          "

      - name: Wait for required checks
        if: steps.security-check.outputs.auto-merge == 'true'
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'Cross-platform Tests'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          allowed-conclusions: success,neutral

      - name: Auto-approve and merge PR
        if: steps.security-check.outputs.auto-merge == 'true'
        run: |
          if [[ "${{ steps.security-check.outputs.is-security }}" == "true" ]]; then
            approval_message="ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã®è‡ªå‹•æ‰¿èª**

            ã“ã®PRã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ä¿®æ­£ã‚’å«ã‚€ãŸã‚ã€è‡ªå‹•æ‰¿èªã•ã‚Œã¾ã—ãŸã€‚

            **æ›´æ–°å†…å®¹:**
            - ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}
            - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}

            CIãƒã‚§ãƒƒã‚¯é€šéå¾Œã«è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚"
          else
            approval_message="âœ… **ãƒ‘ãƒƒãƒ/ãƒã‚¤ãƒŠãƒ¼æ›´æ–°ã®è‡ªå‹•æ‰¿èª**

            ã“ã®PRã¯å®‰å…¨ãªæ›´æ–°ã®ãŸã‚ã€è‡ªå‹•æ‰¿èªã•ã‚Œã¾ã—ãŸã€‚

            **æ›´æ–°å†…å®¹:**
            - ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}
            - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}

            CIãƒã‚§ãƒƒã‚¯é€šéå¾Œã«è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚"
          fi

          gh pr review --approve "${{ github.event.pull_request.number }}" --body "$approval_message"

          gh pr merge --auto --squash "${{ github.event.pull_request.number }}" \
            --subject "deps: ${{ steps.metadata.outputs.dependency-names }}" \
            --body "Dependabotã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°

          **æ›´æ–°ã‚¿ã‚¤ãƒ—:** ${{ steps.metadata.outputs.update-type }}
          **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°:** ${{ steps.security-check.outputs.is-security }}

          ã“ã®PRã¯è‡ªå‹•ãƒ†ã‚¹ãƒˆã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ãŸãŸã‚ã€è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚"

          echo "âœ… è‡ªå‹•ãƒãƒ¼ã‚¸ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Handle manual review cases
        if: steps.security-check.outputs.auto-merge == 'false'
        run: |
          echo "=== æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦ãªæ›´æ–°ã®åˆ†æ ==="

          if [[ "${{ steps.security-check.outputs.is-security }}" == "true" ]]; then
            comment_body="ğŸš¨ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ï¼ˆãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰**

            ã“ã®æ›´æ–°ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ä¿®æ­£ã‚’å«ã¿ã¾ã™ãŒã€ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã®ãŸã‚æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™ã€‚

            **âš ï¸ ç·Šæ€¥åº¦: HIGH - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚ã‚Š**

            **æ›´æ–°å†…å®¹:**
            - ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}
            - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}

            ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ãŸã‚ã€å¯èƒ½ãªé™ã‚Šè¿…é€Ÿã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚"

            gh pr edit "${{ github.event.pull_request.number }}" \
              --add-label "security,high-priority,breaking-change"
          else
            comment_body="âš ï¸ **ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°æ¤œå‡º**

            ã“ã®æ›´æ–°ã¯ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã®ãŸã‚ã€æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™ã€‚

            **æ›´æ–°å†…å®¹:**
            - ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}
            - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}

            å•é¡ŒãŒãªã‘ã‚Œã°æ‰‹å‹•ã§ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚"

            gh pr edit "${{ github.event.pull_request.number }}" \
              --add-label "breaking-change,manual-review"
          fi

          gh pr comment "${{ github.event.pull_request.number }}" --body "$comment_body"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
