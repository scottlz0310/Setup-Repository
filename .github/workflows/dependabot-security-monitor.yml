name: Dependabot Security Monitor

on:
  schedule:
    # æ¯æ—¥åˆå‰8æ™‚ï¼ˆJSTï¼‰ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
    - cron: '0 23 * * *'  # UTC 23:00 = JST 08:00
  workflow_dispatch:
    inputs:
      force_check:
        description: 'å¼·åˆ¶çš„ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  security-events: read
  issues: write
  pull-requests: read

jobs:
  security-status-check:
    name: Security Status Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup UV environment
      uses: ./.github/actions/setup-uv-env
      with:
        python-version: '3.11'

    - name: Check for open security advisories
      id: security-advisories
      run: |
        echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãƒã‚§ãƒƒã‚¯ ==="

        # GitHub CLIã‚’ä½¿ç”¨ã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªã‚’ç¢ºèª
        advisories=$(gh api repos/:owner/:repo/security-advisories --jq '.[] | select(.state == "published")')

        if [[ -n "$advisories" ]]; then
          echo "open-advisories=true" >> $GITHUB_OUTPUT
          echo "ğŸš¨ ã‚ªãƒ¼ãƒ—ãƒ³ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        else
          echo "open-advisories=false" >> $GITHUB_OUTPUT
          echo "âœ… ã‚ªãƒ¼ãƒ—ãƒ³ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªã¯ã‚ã‚Šã¾ã›ã‚“"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Check pending Dependabot PRs
      id: pending-prs
      run: |
        echo "=== ä¿ç•™ä¸­ã®Dependabot PRãƒã‚§ãƒƒã‚¯ ==="

        # Dependabotã«ã‚ˆã‚‹ä¿ç•™ä¸­ã®PRã‚’ç¢ºèª
        pending_prs=$(gh pr list --author "dependabot[bot]" --state open --json number,title,labels)
        security_prs=$(echo "$pending_prs" | jq '[.[] | select(.labels[]?.name == "security")]')

        pr_count=$(echo "$pending_prs" | jq 'length')
        security_pr_count=$(echo "$security_prs" | jq 'length')

        echo "pending-pr-count=$pr_count" >> $GITHUB_OUTPUT
        echo "security-pr-count=$security_pr_count" >> $GITHUB_OUTPUT

        echo "ä¿ç•™ä¸­ã®Dependabot PR: $pr_count ä»¶"
        echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£PR: $security_pr_count ä»¶"

        if [[ "$security_pr_count" -gt 0 ]]; then
          echo "security-prs-pending=true" >> $GITHUB_OUTPUT
          echo "ğŸ”´ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®PRãŒä¿ç•™ä¸­ã§ã™"
        else
          echo "security-prs-pending=false" >> $GITHUB_OUTPUT
          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®PRã¯ã‚ã‚Šã¾ã›ã‚“"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Run dependency vulnerability scan
      id: vulnerability-scan
      run: |
        echo "=== ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ ==="

        # uvã‚’ä½¿ç”¨ã—ã¦ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯
        uv sync --dev

        # Safetyã‚’ä½¿ç”¨ã—ãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        if command -v safety &> /dev/null; then
          safety_result=$(uv run safety check --json || echo "[]")
          vulnerability_count=$(echo "$safety_result" | jq 'length')
        else
          vulnerability_count=0
        fi

        echo "vulnerability-count=$vulnerability_count" >> $GITHUB_OUTPUT

        if [[ "$vulnerability_count" -gt 0 ]]; then
          echo "vulnerabilities-found=true" >> $GITHUB_OUTPUT
          echo "ğŸš¨ $vulnerability_count ä»¶ã®è„†å¼±æ€§ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        else
          echo "vulnerabilities-found=false" >> $GITHUB_OUTPUT
          echo "âœ… è„†å¼±æ€§ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        fi

    - name: Generate security status report
      id: status-report
      run: |
        echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ ==="

        current_date=$(date '+%Y-%m-%d %H:%M:%S JST')

        # ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã®ç”Ÿæˆ
        report="# ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ

        **ç”Ÿæˆæ—¥æ™‚:** $current_date

        ## ğŸ“Š ç¾åœ¨ã®çŠ¶æ³

        ### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒª
        - ã‚ªãƒ¼ãƒ—ãƒ³ãªã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒª: ${{ steps.security-advisories.outputs.open-advisories == 'true' && 'ğŸ”´ ã‚ã‚Š' || 'âœ… ãªã—' }}

        ### Dependabot PR
        - ä¿ç•™ä¸­ã®PRç·æ•°: ${{ steps.pending-prs.outputs.pending-pr-count }} ä»¶
        - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£PR: ${{ steps.pending-prs.outputs.security-pr-count }} ä»¶

        ### ä¾å­˜é–¢ä¿‚è„†å¼±æ€§
        - æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§: ${{ steps.vulnerability-scan.outputs.vulnerability-count }} ä»¶

        ## ğŸ¯ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"

        # æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¿½åŠ 
        if [[ "${{ steps.security-advisories.outputs.open-advisories }}" == "true" ]] || \
           [[ "${{ steps.pending-prs.outputs.security-prs-pending }}" == "true" ]] || \
           [[ "${{ steps.vulnerability-scan.outputs.vulnerabilities-found }}" == "true" ]]; then
          report="$report

        âš ï¸ **å³åº§ã®å¯¾å¿œãŒå¿…è¦ã§ã™:**
        - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®PRã‚’å„ªå…ˆçš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼
        - è„†å¼±æ€§ã®ã‚ã‚‹ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°
        - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ"
        else
          report="$report

        âœ… **ç¾åœ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã¯è‰¯å¥½ã§ã™:**
        - å®šæœŸçš„ãªç›£è¦–ã‚’ç¶™ç¶š
        - ä¾å­˜é–¢ä¿‚ã®æœ€æ–°çŠ¶æ…‹ã‚’ç¶­æŒ"
        fi

        # ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        echo "$report" > security-status-report.md
        echo "report-generated=true" >> $GITHUB_OUTPUT

    - name: Create or update security status issue
      if: |
        steps.security-advisories.outputs.open-advisories == 'true' ||
        steps.pending-prs.outputs.security-prs-pending == 'true' ||
        steps.vulnerability-scan.outputs.vulnerabilities-found == 'true'
      run: |
        echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚¤ã‚·ãƒ¥ãƒ¼ã®ä½œæˆ/æ›´æ–° ==="

        # æ—¢å­˜ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’æ¤œç´¢
        existing_issue=$(gh issue list --label "security-status" --state open --json number | jq -r '.[0].number // empty')

        report_content=$(cat security-status-report.md)

        if [[ -n "$existing_issue" ]]; then
          # æ—¢å­˜ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’æ›´æ–°
          gh issue edit "$existing_issue" --body "$report_content"
          echo "âœ… æ—¢å­˜ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚¤ã‚·ãƒ¥ãƒ¼ #$existing_issue ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
        else
          # æ–°ã—ã„ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ä½œæˆ
          gh issue create \
            --title "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ" \
            --body "$report_content" \
            --label "security-status,monitoring,automated" \
            --assignee "scottlz0310"
          echo "âœ… æ–°ã—ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Close security status issue if all clear
      if: |
        steps.security-advisories.outputs.open-advisories == 'false' &&
        steps.pending-prs.outputs.security-prs-pending == 'false' &&
        steps.vulnerability-scan.outputs.vulnerabilities-found == 'false'
      run: |
        echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³è‰¯å¥½ - ã‚¤ã‚·ãƒ¥ãƒ¼ã®ã‚¯ãƒ­ãƒ¼ã‚ºç¢ºèª ==="

        # æ—¢å­˜ã®ã‚ªãƒ¼ãƒ—ãƒ³ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’æ¤œç´¢
        existing_issue=$(gh issue list --label "security-status" --state open --json number | jq -r '.[0].number // empty')

        if [[ -n "$existing_issue" ]]; then
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ãŒè‰¯å¥½ãªå ´åˆã¯ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ã‚¯ãƒ­ãƒ¼ã‚º
          gh issue close "$existing_issue" --comment "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ãŒæ”¹å–„ã•ã‚Œã¾ã—ãŸã€‚ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒè§£æ±ºã•ã‚Œã¦ã„ã¾ã™ã€‚

          **ç¢ºèªæ¸ˆã¿é …ç›®:**
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒª: ãªã—
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£PR: ãªã—
          - ä¾å­˜é–¢ä¿‚è„†å¼±æ€§: ãªã—

          å®šæœŸç›£è¦–ã¯ç¶™ç¶šã•ã‚Œã¾ã™ã€‚"
          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚¤ã‚·ãƒ¥ãƒ¼ #$existing_issue ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸ"
        else
          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã¯è‰¯å¥½ã§ã™ï¼ˆã‚ªãƒ¼ãƒ—ãƒ³ãªã‚¤ã‚·ãƒ¥ãƒ¼ãªã—ï¼‰"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      run: |
        echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ã‚µãƒãƒªãƒ¼ ==="
        echo "ğŸ” **å®Ÿè¡Œã•ã‚ŒãŸç›£è¦–é …ç›®:**"
        echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãƒã‚§ãƒƒã‚¯"
        echo "- Dependabot PRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª"
        echo "- ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³"
        echo ""
        echo "ğŸ“Š **çµæœ:**"
        echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒª: ${{ steps.security-advisories.outputs.open-advisories == 'true' && 'ğŸ”´ è¦å¯¾å¿œ' || 'âœ… æ­£å¸¸' }}"
        echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£PR: ${{ steps.pending-prs.outputs.security-prs-pending == 'true' && 'ğŸ”´ è¦å¯¾å¿œ' || 'âœ… æ­£å¸¸' }}"
        echo "- ä¾å­˜é–¢ä¿‚è„†å¼±æ€§: ${{ steps.vulnerability-scan.outputs.vulnerabilities-found == 'true' && 'ğŸ”´ è¦å¯¾å¿œ' || 'âœ… æ­£å¸¸' }}"
        echo ""
        echo "æ¬¡å›ç›£è¦–: æ˜æ—¥ 08:00 JST"
