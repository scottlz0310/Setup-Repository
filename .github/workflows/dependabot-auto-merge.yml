name: Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read
  security-events: read

jobs:
  dependabot-auto-merge:
    name: Dependabot Auto-merge
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Get Dependabot metadata
      id: metadata
      uses: dependabot/fetch-metadata@v2
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"

    - name: Analyze update type and security impact
      id: security-check
      run: |
        echo "=== Dependabotæ›´æ–°åˆ†æ ==="
        echo "ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}"
        echo "æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}"
        echo "ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.metadata.outputs.previous-version }}"
        echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.metadata.outputs.new-version }}"
        echo "ã‚¢ãƒ©ãƒ¼ãƒˆçŠ¶æ…‹: ${{ steps.metadata.outputs.alert-state }}"
        echo "CVSSã‚¹ã‚³ã‚¢: ${{ steps.metadata.outputs.cvss }}"

        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã®åˆ¤å®š
        is_security_update=false
        auto_merge_eligible=false
        priority_level="normal"

        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãŒã‚ã‚‹å ´åˆ
        if [[ "${{ steps.metadata.outputs.alert-state }}" == "OPEN" ]] || \
           [[ "${{ steps.metadata.outputs.alert-state }}" == "FIXED" ]]; then
          is_security_update=true
          priority_level="high"
          echo "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
        fi

        # æ›´æ–°ã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹è‡ªå‹•ãƒãƒ¼ã‚¸åˆ¤å®š
        case "${{ steps.metadata.outputs.update-type }}" in
          "version-update:semver-patch")
            auto_merge_eligible=true
            echo "âœ… ãƒ‘ãƒƒãƒæ›´æ–°: è‡ªå‹•ãƒãƒ¼ã‚¸å¯¾è±¡"
            ;;
          "version-update:semver-minor")
            auto_merge_eligible=true
            echo "âœ… ãƒã‚¤ãƒŠãƒ¼æ›´æ–°: è‡ªå‹•ãƒãƒ¼ã‚¸å¯¾è±¡"
            ;;
          "version-update:semver-major")
            auto_merge_eligible=false
            echo "âš ï¸ ãƒ¡ã‚¸ãƒ£ãƒ¼æ›´æ–°: æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦"
            ;;
          *)
            auto_merge_eligible=false
            echo "â“ ä¸æ˜ãªæ›´æ–°ã‚¿ã‚¤ãƒ—: æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦"
            ;;
        esac

        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã¯å„ªå…ˆçš„ã«è‡ªå‹•ãƒãƒ¼ã‚¸
        if [[ "$is_security_update" == "true" ]]; then
          auto_merge_eligible=true
          echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã®ãŸã‚è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’æœ‰åŠ¹åŒ–"
        fi

        echo "is-security=$is_security_update" >> $GITHUB_OUTPUT
        echo "auto-merge=$auto_merge_eligible" >> $GITHUB_OUTPUT
        echo "priority=$priority_level" >> $GITHUB_OUTPUT

    - name: Setup UV environment for testing
      if: steps.security-check.outputs.auto-merge == 'true'
      uses: ./.github/actions/setup-uv-env
      with:
        python-version: '3.11'

    - name: Run dependency compatibility tests
      if: steps.security-check.outputs.auto-merge == 'true'
      id: compatibility-test
      run: |
        echo "=== ä¾å­˜é–¢ä¿‚äº’æ›æ€§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ==="

        # åŸºæœ¬çš„ãªã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
        uv run python -c "
        import sys
        import importlib

        # ä¸»è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
        try:
            import setup_repo
            print('âœ… setup_repo ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ')
        except ImportError as e:
            print(f'âŒ setup_repo ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: {e}')
            sys.exit(1)

        # ä¾å­˜é–¢ä¿‚ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯
        try:
            import requests
            import click
            print('âœ… ä¸»è¦ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ')
        except ImportError as e:
            print(f'âŒ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: {e}')
            sys.exit(1)
        "

        # ç°¡å˜ãªæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        uv run python -c "
        from src.setup_repo.config import load_config
        from src.setup_repo.platform_detector import detect_platform

        try:
            config = load_config()
            platform = detect_platform()
            print(f'âœ… åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆæˆåŠŸ: ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ={platform}')
        except Exception as e:
            print(f'âŒ åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå¤±æ•—: {e}')
            import sys
            sys.exit(1)
        "

        echo "compatibility-test=success" >> $GITHUB_OUTPUT

    - name: Wait for all required checks
      if: steps.security-check.outputs.auto-merge == 'true'
      uses: lewagon/wait-on-check-action@v1.3.4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        check-name: 'Code Quality Checks'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        wait-interval: 30
        allowed-conclusions: success

    - name: Wait for security scan completion
      if: steps.security-check.outputs.auto-merge == 'true'
      uses: lewagon/wait-on-check-action@v1.3.4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        check-name: 'Security Vulnerability Scan'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        wait-interval: 30
        allowed-conclusions: success,neutral

    - name: Verify PR is ready for auto-merge
      if: steps.security-check.outputs.auto-merge == 'true'
      id: merge-readiness
      run: |
        echo "=== è‡ªå‹•ãƒãƒ¼ã‚¸æº–å‚™çŠ¶æ³ç¢ºèª ==="

        # PRã®çŠ¶æ…‹ç¢ºèª
        pr_state=$(gh pr view "${{ github.event.pull_request.number }}" --json state,mergeable,reviewDecision --jq '.state')
        pr_mergeable=$(gh pr view "${{ github.event.pull_request.number }}" --json mergeable --jq '.mergeable')
        review_decision=$(gh pr view "${{ github.event.pull_request.number }}" --json reviewDecision --jq '.reviewDecision')

        echo "PRçŠ¶æ…‹: $pr_state"
        echo "ãƒãƒ¼ã‚¸å¯èƒ½: $pr_mergeable"
        echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼æ±ºå®š: $review_decision"

        # ãƒãƒ¼ã‚¸æº–å‚™å®Œäº†ã®åˆ¤å®š
        if [[ "$pr_state" == "OPEN" ]] && [[ "$pr_mergeable" == "MERGEABLE" ]]; then
          echo "ready-for-merge=true" >> $GITHUB_OUTPUT
          echo "âœ… è‡ªå‹•ãƒãƒ¼ã‚¸æº–å‚™å®Œäº†"
        else
          echo "ready-for-merge=false" >> $GITHUB_OUTPUT
          echo "âŒ è‡ªå‹•ãƒãƒ¼ã‚¸æº–å‚™æœªå®Œäº†"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Auto-approve PR
      if: |
        steps.security-check.outputs.auto-merge == 'true' &&
        steps.compatibility-test.outputs.compatibility-test == 'success' &&
        steps.merge-readiness.outputs.ready-for-merge == 'true'
      run: |
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã‹ã©ã†ã‹ã§æ‰¿èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
        if [[ "${{ steps.security-check.outputs.is-security }}" == "true" ]]; then
          approval_message="ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã®è‡ªå‹•æ‰¿èª**

          ã“ã®PRã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ä¿®æ­£ã‚’å«ã‚€ãŸã‚ã€è‡ªå‹•æ‰¿èªã•ã‚Œã¾ã—ãŸã€‚

          **æ›´æ–°å†…å®¹:**
          - ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}
          - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}
          - å„ªå…ˆåº¦: ${{ steps.security-check.outputs.priority }}

          **å®Ÿè¡Œã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯:**
          âœ… ä¾å­˜é–¢ä¿‚äº’æ›æ€§ãƒ†ã‚¹ãƒˆ
          âœ… ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
          âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³

          CIãƒã‚§ãƒƒã‚¯é€šéå¾Œã«è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚"
        else
          approval_message="âœ… **ãƒ‘ãƒƒãƒ/ãƒã‚¤ãƒŠãƒ¼æ›´æ–°ã®è‡ªå‹•æ‰¿èª**

          ã“ã®PRã¯å®‰å…¨ãªæ›´æ–°ã®ãŸã‚ã€è‡ªå‹•æ‰¿èªã•ã‚Œã¾ã—ãŸã€‚

          **æ›´æ–°å†…å®¹:**
          - ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}
          - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}

          **å®Ÿè¡Œã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯:**
          âœ… ä¾å­˜é–¢ä¿‚äº’æ›æ€§ãƒ†ã‚¹ãƒˆ
          âœ… ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
          âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³

          CIãƒã‚§ãƒƒã‚¯é€šéå¾Œã«è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚"
        fi

        gh pr review --approve "${{ github.event.pull_request.number }}" --body "$approval_message"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Enable auto-merge
      if: |
        steps.security-check.outputs.auto-merge == 'true' &&
        steps.compatibility-test.outputs.compatibility-test == 'success' &&
        steps.merge-readiness.outputs.ready-for-merge == 'true'
      run: |
        # è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’æœ‰åŠ¹åŒ–
        gh pr merge --auto --squash "${{ github.event.pull_request.number }}" \
          --subject "deps: ${{ steps.metadata.outputs.dependency-names }}" \
          --body "Dependabotã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°

        **æ›´æ–°ã‚¿ã‚¤ãƒ—:** ${{ steps.metadata.outputs.update-type }}
        **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°:** ${{ steps.security-check.outputs.is-security }}
        **å„ªå…ˆåº¦:** ${{ steps.security-check.outputs.priority }}

        ã“ã®PRã¯è‡ªå‹•ãƒ†ã‚¹ãƒˆã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ãŸãŸã‚ã€è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚"

        echo "âœ… è‡ªå‹•ãƒãƒ¼ã‚¸ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Handle manual review cases
      if: steps.security-check.outputs.auto-merge == 'false'
      run: |
        # ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ã®å ´åˆã®è©³ç´°åˆ†æ
        echo "=== æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦ãªæ›´æ–°ã®åˆ†æ ==="

        # ç ´å£Šçš„å¤‰æ›´ã®å¯èƒ½æ€§ã‚’åˆ†æ
        breaking_change_risk="medium"
        if [[ "${{ steps.metadata.outputs.update-type }}" == "version-update:semver-major" ]]; then
          breaking_change_risk="high"
        fi

        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã§ã‚‚ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å ´åˆã¯ç‰¹åˆ¥æ‰±ã„
        if [[ "${{ steps.security-check.outputs.is-security }}" == "true" ]]; then
          comment_body="ğŸš¨ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ï¼ˆãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰**

          ã“ã®æ›´æ–°ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ä¿®æ­£ã‚’å«ã¿ã¾ã™ãŒã€ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã®ãŸã‚æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™ã€‚

          **âš ï¸ ç·Šæ€¥åº¦: HIGH - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚ã‚Š**

          **æ›´æ–°å†…å®¹:**
          - ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}
          - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}
          - ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.metadata.outputs.previous-version }}
          - æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.metadata.outputs.new-version }}
          - CVSSã‚¹ã‚³ã‚¢: ${{ steps.metadata.outputs.cvss }}
          - ã‚¢ãƒ©ãƒ¼ãƒˆçŠ¶æ…‹: ${{ steps.metadata.outputs.alert-state }}

          **ğŸ” å¿…é ˆç¢ºèªäº‹é …:**
          1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: è„†å¼±æ€§ãŒç¢ºå®Ÿã«ä¿®æ­£ã•ã‚Œã‚‹ã‹ç¢ºèª
          2. **ç ´å£Šçš„å¤‰æ›´**: APIã®å¤‰æ›´ã‚„éäº’æ›æ€§ãŒãªã„ã‹ç¢ºèª
          3. **ãƒ†ã‚¹ãƒˆ**: å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šéã™ã‚‹ã“ã¨ã‚’ç¢ºèª
          4. **ä¾å­˜é–¢ä¿‚**: ä»–ã®ä¾å­˜é–¢ä¿‚ã¨ã®ç«¶åˆãŒãªã„ã‹ç¢ºèª
          5. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: å¿…è¦ã«å¿œã˜ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

          **ğŸš€ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**
          ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ãŸã‚ã€å¯èƒ½ãªé™ã‚Šè¿…é€Ÿã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚"

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã®å ´åˆã¯é«˜å„ªå…ˆåº¦ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          gh pr edit "${{ github.event.pull_request.number }}" \
            --add-label "security,high-priority,breaking-change"
        else
          comment_body="âš ï¸ **ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°æ¤œå‡º**

          ã“ã®æ›´æ–°ã¯ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã®ãŸã‚ã€æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™ã€‚

          **æ›´æ–°å†…å®¹:**
          - ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}
          - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}
          - ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.metadata.outputs.previous-version }}
          - æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.metadata.outputs.new-version }}
          - ç ´å£Šçš„å¤‰æ›´ãƒªã‚¹ã‚¯: $breaking_change_risk

          **ğŸ” ç¢ºèªäº‹é …:**
          1. **ç ´å£Šçš„å¤‰æ›´**: APIã®å¤‰æ›´ã‚„éäº’æ›æ€§ãŒãªã„ã‹ç¢ºèª
          2. **ãƒ†ã‚¹ãƒˆ**: å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šéã™ã‚‹ã“ã¨ã‚’ç¢ºèª
          3. **ä¾å­˜é–¢ä¿‚**: ä»–ã®ä¾å­˜é–¢ä¿‚ã¨ã®ç«¶åˆãŒãªã„ã‹ç¢ºèª
          4. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: å¿…è¦ã«å¿œã˜ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
          5. **CHANGELOG**: å¤‰æ›´ãƒ­ã‚°ã®æ›´æ–°ãŒå¿…è¦ã‹ç¢ºèª

          **ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯:**
          - [ä¾å­˜é–¢ä¿‚ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ](${{ steps.metadata.outputs.homepage }})
          - [å¤‰æ›´ãƒ­ã‚°](${{ steps.metadata.outputs.changelog }})

          å•é¡ŒãŒãªã‘ã‚Œã°æ‰‹å‹•ã§ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚"

          # é€šå¸¸ã®ãƒ¡ã‚¸ãƒ£ãƒ¼æ›´æ–°ã®å ´åˆã®ãƒ©ãƒ™ãƒ«
          gh pr edit "${{ github.event.pull_request.number }}" \
            --add-label "breaking-change,manual-review"
        fi

        gh pr comment "${{ github.event.pull_request.number }}" --body "$comment_body"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-notification:
    name: Security Update Notification
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    needs: dependabot-auto-merge

    steps:
    - name: Get Dependabot metadata
      id: metadata
      uses: dependabot/fetch-metadata@v2
      with:
        github-token: "${{ secrets.GITHUB_TOKEN }}"

    - name: Analyze security impact
      id: security-analysis
      run: |
        echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å½±éŸ¿åˆ†æ ==="

        is_security_update=false
        severity_level="unknown"
        cvss_score="${{ steps.metadata.outputs.cvss }}"
        alert_state="${{ steps.metadata.outputs.alert-state }}"

        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªã®ç¢ºèª
        if [[ "$alert_state" == "OPEN" ]] || [[ "$alert_state" == "FIXED" ]]; then
          is_security_update=true

          # CVSSã‚¹ã‚³ã‚¢ã«åŸºã¥ãé‡è¦åº¦åˆ¤å®š
          if [[ -n "$cvss_score" ]]; then
            cvss_numeric=$(echo "$cvss_score" | grep -oE '[0-9]+\.?[0-9]*' | head -1)
            if (( $(echo "$cvss_numeric >= 9.0" | bc -l) )); then
              severity_level="critical"
            elif (( $(echo "$cvss_numeric >= 7.0" | bc -l) )); then
              severity_level="high"
            elif (( $(echo "$cvss_numeric >= 4.0" | bc -l) )); then
              severity_level="medium"
            else
              severity_level="low"
            fi
          else
            severity_level="medium"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
          fi

          echo "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§æ¤œå‡º"
          echo "é‡è¦åº¦: $severity_level"
          echo "CVSSã‚¹ã‚³ã‚¢: $cvss_score"
        fi

        echo "is-security=$is_security_update" >> $GITHUB_OUTPUT
        echo "severity=$severity_level" >> $GITHUB_OUTPUT
        echo "cvss-score=$cvss_score" >> $GITHUB_OUTPUT

    - name: Create security tracking issue
      if: steps.security-analysis.outputs.is-security == 'true'
      run: |
        severity="${{ steps.security-analysis.outputs.severity }}"
        cvss_score="${{ steps.security-analysis.outputs.cvss-score }}"

        # é‡è¦åº¦ã«å¿œã˜ãŸãƒ©ãƒ™ãƒ«ã¨ã‚¢ã‚µã‚¤ãƒ‹ãƒ¼ã®è¨­å®š
        case "$severity" in
          "critical")
            labels="security,critical,dependencies,immediate-action"
            priority_emoji="ğŸ”´"
            urgency="å³åº§ã«å¯¾å¿œãŒå¿…è¦"
            ;;
          "high")
            labels="security,high-priority,dependencies"
            priority_emoji="ğŸŸ "
            urgency="24æ™‚é–“ä»¥å†…ã«å¯¾å¿œæ¨å¥¨"
            ;;
          "medium")
            labels="security,medium-priority,dependencies"
            priority_emoji="ğŸŸ¡"
            urgency="1é€±é–“ä»¥å†…ã«å¯¾å¿œæ¨å¥¨"
            ;;
          *)
            labels="security,low-priority,dependencies"
            priority_emoji="ğŸŸ¢"
            urgency="æ¬¡å›ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚ã«å¯¾å¿œ"
            ;;
        esac

        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ã‚·ãƒ¥ãƒ¼ã®ä½œæˆ
        issue_body="$priority_emoji **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§æ¤œå‡ºãƒ¬ãƒãƒ¼ãƒˆ**

        DependabotãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚’æ¤œå‡ºã—ã€ä¿®æ­£ã®ãŸã‚ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚

        ## ğŸ“Š è„†å¼±æ€§æƒ…å ±
        - **å½±éŸ¿ã‚’å—ã‘ã‚‹ä¾å­˜é–¢ä¿‚:** ${{ steps.metadata.outputs.dependency-names }}
        - **ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** ${{ steps.metadata.outputs.previous-version }}
        - **ä¿®æ­£ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** ${{ steps.metadata.outputs.new-version }}
        - **é‡è¦åº¦:** $severity
        - **CVSSã‚¹ã‚³ã‚¢:** $cvss_score
        - **ã‚¢ãƒ©ãƒ¼ãƒˆçŠ¶æ…‹:** ${{ steps.metadata.outputs.alert-state }}

        ## ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯
        - **ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:** #${{ github.event.pull_request.number }}
        - **GitHub Advisory:** ${{ steps.metadata.outputs.advisory-ghsa-id }}

        ## â° å¯¾å¿œæœŸé™
        **$urgency**

        ## âœ… å¯¾å¿œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
        - [ ] ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†
        - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œç¢ºèª
        - [ ] ä¾å­˜é–¢ä¿‚ã®äº’æ›æ€§ç¢ºèª
        - [ ] æœ¬ç•ªç’°å¢ƒã¸ã®å½±éŸ¿è©•ä¾¡
        - [ ] ãƒãƒ¼ã‚¸å®Ÿè¡Œ
        - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ã®å‹•ä½œç¢ºèª

        ## ğŸ“ è¿½åŠ æƒ…å ±
        ã“ã®ã‚¤ã‚·ãƒ¥ãƒ¼ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ãŒå®Œäº†ã—ãŸã‚‰ã€ã“ã®ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„ã€‚"

        gh issue create \
          --title "$priority_emoji ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°: ${{ steps.metadata.outputs.dependency-names }} ($severity)" \
          --body "$issue_body" \
          --label "$labels" \
          --assignee "scottlz0310"

        echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¿½è·¡ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Send security notification summary
      if: steps.security-analysis.outputs.is-security == 'true'
      run: |
        echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é€šçŸ¥ã‚µãƒãƒªãƒ¼ ==="
        echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
        echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}"
        echo "âš ï¸ é‡è¦åº¦: ${{ steps.security-analysis.outputs.severity }}"
        echo "ğŸ“Š CVSSã‚¹ã‚³ã‚¢: ${{ steps.security-analysis.outputs.cvss-score }}"
        echo "ğŸ”— ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: #${{ github.event.pull_request.number }}"
        echo ""
        echo "é©åˆ‡ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚"

  dependency-update-summary:
    name: Dependency Update Summary
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    needs: [dependabot-auto-merge, security-notification]

    steps:
    - name: Generate update summary
      run: |
        echo "=== Dependabotæ›´æ–°ã‚µãƒãƒªãƒ¼ ==="
        echo "ğŸ“¦ **ä¾å­˜é–¢ä¿‚æ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆ**"
        echo ""
        echo "**æ›´æ–°ã•ã‚ŒãŸä¾å­˜é–¢ä¿‚:** ${{ needs.dependabot-auto-merge.outputs.dependency-names || 'N/A' }}"
        echo "**æ›´æ–°ã‚¿ã‚¤ãƒ—:** ${{ needs.dependabot-auto-merge.outputs.update-type || 'N/A' }}"
        echo "**è‡ªå‹•ãƒãƒ¼ã‚¸:** ${{ needs.dependabot-auto-merge.outputs.auto-merge || 'false' }}"
        echo "**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°:** ${{ needs.security-notification.outputs.is-security || 'false' }}"
        echo ""
        echo "è©³ç´°ã¯é–¢é€£ã™ã‚‹ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
