name: Quality Report

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  quality-report:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å±¥æ­´å…¨ä½“ã‚’å–å¾—ï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æç”¨ï¼‰

    - name: Setup UV environment
      uses: ./.github/actions/setup-uv-env

    - name: Install additional dependencies for quality checks
      run: |
        uv add --dev bandit safety pytest-json-report

    - name: Collect quality metrics
      id: quality
      run: |
        # å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
        uv run python main.py quality --output quality-report.json

        # çµæœã‚’GitHub Actionså‡ºåŠ›ã«è¨­å®š
        if [ -f quality-report.json ]; then
          QUALITY_SCORE=$(cat quality-report.json | jq -r '.quality_score')
          COVERAGE=$(cat quality-report.json | jq -r '.metrics.test_coverage')
          RUFF_ISSUES=$(cat quality-report.json | jq -r '.metrics.ruff_issues')
          MYPY_ERRORS=$(cat quality-report.json | jq -r '.metrics.mypy_errors')
          SECURITY_VULNS=$(cat quality-report.json | jq -r '.metrics.security_vulnerabilities')

          echo "quality_score=$QUALITY_SCORE" >> $GITHUB_OUTPUT
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "ruff_issues=$RUFF_ISSUES" >> $GITHUB_OUTPUT
          echo "mypy_errors=$MYPY_ERRORS" >> $GITHUB_OUTPUT
          echo "security_vulnerabilities=$SECURITY_VULNS" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true

    - name: Generate quality badge data
      run: |
        # ãƒãƒƒã‚¸ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        mkdir -p badges

        QUALITY_SCORE="${{ steps.quality.outputs.quality_score }}"
        COVERAGE="${{ steps.quality.outputs.coverage }}"

        # å“è³ªã‚¹ã‚³ã‚¢ãƒãƒƒã‚¸
        if (( $(echo "$QUALITY_SCORE >= 90" | bc -l) )); then
          COLOR="brightgreen"
        elif (( $(echo "$QUALITY_SCORE >= 80" | bc -l) )); then
          COLOR="green"
        elif (( $(echo "$QUALITY_SCORE >= 70" | bc -l) )); then
          COLOR="yellow"
        else
          COLOR="red"
        fi

        echo "{\"schemaVersion\": 1, \"label\": \"quality\", \"message\": \"${QUALITY_SCORE}%\", \"color\": \"$COLOR\"}" > badges/quality.json

        # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒãƒƒã‚¸
        if (( $(echo "$COVERAGE >= 90" | bc -l) )); then
          COV_COLOR="brightgreen"
        elif (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          COV_COLOR="green"
        elif (( $(echo "$COVERAGE >= 70" | bc -l) )); then
          COV_COLOR="yellow"
        else
          COV_COLOR="red"
        fi

        echo "{\"schemaVersion\": 1, \"label\": \"coverage\", \"message\": \"${COVERAGE}%\", \"color\": \"$COV_COLOR\"}" > badges/coverage.json

    - name: Upload quality report
      uses: actions/upload-artifact@v4
      with:
        name: quality-report-${{ github.sha }}
        path: |
          quality-report.json
          badges/
        retention-days: 30

    - name: Comment PR with quality report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          if (!fs.existsSync('quality-report.json')) {
            console.log('Quality report not found');
            return;
          }

          const report = JSON.parse(fs.readFileSync('quality-report.json', 'utf8'));
          const metrics = report.metrics;

          const qualityScore = report.quality_score.toFixed(1);
          const coverage = metrics.test_coverage.toFixed(1);

          // å“è³ªã‚¹ã‚³ã‚¢ã®çµµæ–‡å­—
          let scoreEmoji = 'ğŸ”´';
          if (report.quality_score >= 90) scoreEmoji = 'ğŸŸ¢';
          else if (report.quality_score >= 80) scoreEmoji = 'ğŸŸ¡';
          else if (report.quality_score >= 70) scoreEmoji = 'ğŸŸ ';

          // ã‚«ãƒãƒ¬ãƒƒã‚¸ã®çµµæ–‡å­—
          let coverageEmoji = 'ğŸ”´';
          if (metrics.test_coverage >= 90) coverageEmoji = 'ğŸŸ¢';
          else if (metrics.test_coverage >= 80) coverageEmoji = 'ğŸŸ¡';
          else if (metrics.test_coverage >= 70) coverageEmoji = 'ğŸŸ ';

          const body = `## ğŸ“Š å“è³ªãƒ¬ãƒãƒ¼ãƒˆ

          | ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | å€¤ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
          |-----------|----|-----------|
          | å“è³ªã‚¹ã‚³ã‚¢ | ${qualityScore}% | ${scoreEmoji} |
          | ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ | ${coverage}% | ${coverageEmoji} |
          | Ruffã‚¨ãƒ©ãƒ¼ | ${metrics.ruff_issues}ä»¶ | ${metrics.ruff_issues === 0 ? 'âœ…' : 'âŒ'} |
          | MyPyã‚¨ãƒ©ãƒ¼ | ${metrics.mypy_errors}ä»¶ | ${metrics.mypy_errors === 0 ? 'âœ…' : 'âŒ'} |
          | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ | ${metrics.security_vulnerabilities}ä»¶ | ${metrics.security_vulnerabilities === 0 ? 'âœ…' : 'âŒ'} |
          | ãƒ†ã‚¹ãƒˆæˆåŠŸ | ${metrics.test_passed}ä»¶ | âœ… |
          | ãƒ†ã‚¹ãƒˆå¤±æ•— | ${metrics.test_failed}ä»¶ | ${metrics.test_failed === 0 ? 'âœ…' : 'âŒ'} |

          **ã‚³ãƒŸãƒƒãƒˆ**: \`${report.commit_hash}\`
          **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: ${report.timestamp}

          ${report.passing ? 'ğŸ‰ **å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™ï¼**' : 'âš ï¸ **å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“**'}
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Update quality trend data
      if: github.ref == 'refs/heads/main'
      run: |
        # ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
        mkdir -p quality-trends

        # æ—¢å­˜ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        if [ -f quality-trends/trend-data.json ]; then
          TREND_DATA=$(cat quality-trends/trend-data.json)
        else
          TREND_DATA="[]"
        fi

        # æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ 
        NEW_POINT=$(cat quality-report.json | jq '{
          timestamp: .timestamp,
          commit_hash: .commit_hash,
          quality_score: .quality_score,
          coverage: .metrics.test_coverage,
          ruff_issues: .metrics.ruff_issues,
          mypy_errors: .metrics.mypy_errors,
          security_vulnerabilities: .metrics.security_vulnerabilities
        }')

        # ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆæœ€æ–°30ä»¶ã‚’ä¿æŒï¼‰
        echo "$TREND_DATA" | jq ". + [$NEW_POINT] | sort_by(.timestamp) | .[-30:]" > quality-trends/trend-data.json

    - name: Generate trend visualization
      if: github.ref == 'refs/heads/main'
      run: |
        # ç°¡å˜ãªHTMLãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        cat > quality-trends/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>å“è³ªãƒˆãƒ¬ãƒ³ãƒ‰</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <meta charset="UTF-8">
        </head>
        <body>
            <h1>å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒˆãƒ¬ãƒ³ãƒ‰</h1>
            <div style="width: 800px; height: 400px;">
                <canvas id="qualityChart"></canvas>
            </div>
            <div style="width: 800px; height: 400px;">
                <canvas id="coverageChart"></canvas>
            </div>

            <script>
            fetch('trend-data.json')
                .then(response => response.json())
                .then(data => {
                    const labels = data.map(d => new Date(d.timestamp).toLocaleDateString('ja-JP'));

                    // å“è³ªã‚¹ã‚³ã‚¢ãƒãƒ£ãƒ¼ãƒˆ
                    new Chart(document.getElementById('qualityChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'å“è³ªã‚¹ã‚³ã‚¢',
                                data: data.map(d => d.quality_score),
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'å“è³ªã‚¹ã‚³ã‚¢ãƒˆãƒ¬ãƒ³ãƒ‰'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100
                                }
                            }
                        }
                    });

                    // ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒãƒ£ãƒ¼ãƒˆ
                    new Chart(document.getElementById('coverageChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸',
                                data: data.map(d => d.coverage),
                                borderColor: 'rgb(255, 99, 132)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒˆãƒ¬ãƒ³ãƒ‰'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100
                                }
                            }
                        }
                    });
                });
            </script>
        </body>
        </html>
        EOF

    - name: Upload trend data
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: quality-trends
        path: quality-trends/
        retention-days: 90

    - name: Fail if quality standards not met
      if: steps.quality.outputs.quality_score != '' && steps.quality.outputs.quality_score < 70
      run: |
        echo "âŒ å“è³ªã‚¹ã‚³ã‚¢ãŒåŸºæº–å€¤ï¼ˆ70%ï¼‰ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™: ${{ steps.quality.outputs.quality_score }}%"
        exit 1
