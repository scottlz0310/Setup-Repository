name: Security Management

run-name: "Security Management - ${{ github.event_name == 'schedule' && (github.event.schedule == '0 2 * * *' && 'Daily Scan' || github.event.schedule == '0 23 * * *' && 'Security Monitor') || github.event_name == 'pull_request' && format('PR #{0}', github.event.number) || github.event_name == 'workflow_dispatch' && 'Manual' || github.ref_name }}"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆUTCï¼‰- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    - cron: "0 2 * * *"
    # æ¯æ—¥åˆå¾Œ11æ™‚ï¼ˆUTCï¼‰- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–
    - cron: "0 23 * * *"
  workflow_dispatch:
    inputs:
      security_mode:
        description: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰"
        required: false
        default: "full"
        type: choice
        options:
          - "scan"
          - "monitor"
          - "dependabot"
          - "full"
      force_check:
        description: "å¼·åˆ¶çš„ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: write
  security-events: write
  actions: read
  pull-requests: write
  issues: write
  checks: read

env:
  PYTHON_VERSION: "3.11"

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'schedule' && github.event.schedule == '0 2 * * *') ||
      (github.event_name == 'workflow_dispatch' && (inputs.security_mode == 'scan' || inputs.security_mode == 'full'))

    outputs:
      safety_issues: ${{ steps.security-analysis.outputs.safety_issues }}
      bandit_high: ${{ steps.security-analysis.outputs.bandit_high }}
      bandit_medium: ${{ steps.security-analysis.outputs.bandit_medium }}
      secret_count: ${{ steps.security-analysis.outputs.secret_count }}
      license_violations: ${{ steps.security-analysis.outputs.license_violations }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Create virtual environment
        run: uv venv --python ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Install security tools
        run: |
          echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è©¦è¡Œã—ã¾ã™..."

          # å€‹åˆ¥ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ç¶™ç¶šï¼‰
          uv pip install safety || echo "Safetyã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶™ç¶šï¼‰"
          uv pip install bandit || echo "Banditã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶™ç¶šï¼‰"
          uv pip install pip-licenses || echo "pip-licensesã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç¶™ç¶šï¼‰"

          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ³ã‚’ç¢ºèª
          echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¾ã™:"
          uv run safety --version 2>/dev/null && echo "- Safety: åˆ©ç”¨å¯èƒ½" || echo "- Safety: åˆ©ç”¨ä¸å¯"
          uv run bandit --version 2>/dev/null && echo "- Bandit: åˆ©ç”¨å¯èƒ½" || echo "- Bandit: åˆ©ç”¨ä¸å¯"
          uv run pip-licenses --version 2>/dev/null && echo "- pip-licenses: åˆ©ç”¨å¯èƒ½" || echo "- pip-licenses: åˆ©ç”¨ä¸å¯"

      - name: Run comprehensive security analysis
        id: security-analysis
        env:
          SAFETY_API_KEY: ${{ secrets.SAFETY_API_KEY }}
        run: |
          echo "ğŸ” åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æã‚’å®Ÿè¡Œä¸­..."

          # Safety check for known vulnerabilities
          echo "=== Safety Check ==="
          if [ -n "${SAFETY_API_KEY}" ]; then
            echo "Safety API Key detected"
          else
            echo "Safety API Key not set (free mode)"
          fi

          if uv run safety scan --output json --save-as safety-report.json; then
            echo "âœ… Safetyã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ"
          else
            echo "âš ï¸ Safetyã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ï¼ˆç¶™ç¶šï¼‰"
            echo '{"vulnerabilities": []}' > safety-report.json
          fi

          # Bandit security linter
          echo "=== Bandit Security Linter ==="
          if uv run bandit -r src/ -f json -o bandit-report.json; then
            echo "âœ… Banditã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ"
          else
            echo "âš ï¸ Banditã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ï¼ˆç¶™ç¶šï¼‰"
            echo '{"results": []}' > bandit-report.json
          fi

          # TruffleHog secret scan
          echo "=== TruffleHog Secret Scan ==="
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

          if trufflehog git file://. --json --output trufflehog-report.json; then
            echo "âœ… TruffleHogã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ"
          else
            echo "âš ï¸ TruffleHogã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—ï¼ˆç¶™ç¶šï¼‰"
            echo '[]' > trufflehog-report.json
          fi

          # License compliance check
          echo "=== License Compliance Check ==="
          if uv run pip-licenses --format=json --output-file=licenses-report.json; then
            echo "âœ… ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
          else
            echo "âš ï¸ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—ï¼ˆç¶™ç¶šï¼‰"
            echo '[]' > licenses-report.json
          fi

          # Analyze results
          SAFETY_ISSUES=$(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo "0")
          BANDIT_HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json 2>/dev/null || echo "0")
          BANDIT_MEDIUM=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-report.json 2>/dev/null || echo "0")
          SECRET_COUNT=$(jq '. | length' trufflehog-report.json 2>/dev/null || echo "0")

          # License violations
          FORBIDDEN_LICENSES=$(jq -r '.[] | select(.License | test("GPL|AGPL|LGPL"; "i")) | .Name' licenses-report.json 2>/dev/null | wc -l || echo "0")

          echo "safety_issues=$SAFETY_ISSUES" >> $GITHUB_OUTPUT
          echo "bandit_high=$BANDIT_HIGH" >> $GITHUB_OUTPUT
          echo "bandit_medium=$BANDIT_MEDIUM" >> $GITHUB_OUTPUT
          echo "secret_count=$SECRET_COUNT" >> $GITHUB_OUTPUT
          echo "license_violations=$FORBIDDEN_LICENSES" >> $GITHUB_OUTPUT

          echo "ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æçµæœ:"
          echo "  Safetyè„†å¼±æ€§: $SAFETY_ISSUES ä»¶"
          echo "  Bandité«˜ãƒªã‚¹ã‚¯: $BANDIT_HIGH ä»¶"
          echo "  Banditä¸­ãƒªã‚¹ã‚¯: $BANDIT_MEDIUM ä»¶"
          echo "  æ½œåœ¨çš„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ: $SECRET_COUNT ä»¶"
          echo "  ãƒ©ã‚¤ã‚»ãƒ³ã‚¹é•å: $FORBIDDEN_LICENSES ä»¶"

      - name: Run dependency review
        if: github.event_name == 'pull_request' && github.repository_visibility == 'public'
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0, LGPL-2.1, LGPL-3.0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

      - name: Generate security summary
        run: |
          echo "ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒãƒªãƒ¼ç”Ÿæˆä¸­..."

          cat > security-summary.md << 'EOF'
          # ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ

          ## å®Ÿè¡Œæ—¥æ™‚
          EOF

          echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-summary.md
          echo "" >> security-summary.md

          echo "## è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³çµæœ" >> security-summary.md
          echo "" >> security-summary.md
          echo "- **Safety**: ${{ steps.security-analysis.outputs.safety_issues }} ä»¶ã®æ—¢çŸ¥ã®è„†å¼±æ€§" >> security-summary.md
          echo "- **Bandit**: ${{ steps.security-analysis.outputs.bandit_high }} ä»¶ã®é«˜ãƒªã‚¹ã‚¯ã€${{ steps.security-analysis.outputs.bandit_medium }} ä»¶ã®ä¸­ãƒªã‚¹ã‚¯" >> security-summary.md
          echo "- **TruffleHog**: ${{ steps.security-analysis.outputs.secret_count }} ä»¶ã®æ½œåœ¨çš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ" >> security-summary.md
          echo "- **ãƒ©ã‚¤ã‚»ãƒ³ã‚¹**: ${{ steps.security-analysis.outputs.license_violations }} ä»¶ã®é•å" >> security-summary.md
          echo "" >> security-summary.md

          # ç·åˆåˆ¤å®š
          TOTAL_CRITICAL=$((${{ steps.security-analysis.outputs.safety_issues }} + ${{ steps.security-analysis.outputs.bandit_high }} + ${{ steps.security-analysis.outputs.secret_count }} + ${{ steps.security-analysis.outputs.license_violations }}))

          if [ "$TOTAL_CRITICAL" -eq 0 ]; then
            echo "âœ… **ç·åˆåˆ¤å®š**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> security-summary.md
          elif [ "$TOTAL_CRITICAL" -le 3 ]; then
            echo "âš ï¸ **ç·åˆåˆ¤å®š**: è»½å¾®ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> security-summary.md
          else
            echo "âŒ **ç·åˆåˆ¤å®š**: é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> security-summary.md
          fi

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results-${{ github.sha }}
          path: |
            safety-report.json
            bandit-report.json
            trufflehog-report.json
            licenses-report.json
            security-summary.md
          retention-days: 90

      - name: Check for critical vulnerabilities
        run: |
          echo "ğŸš¨ é‡è¦ãªè„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ä¸­..."

          CRITICAL_ISSUES=0

          # Safetyçµæœã‚’ãƒã‚§ãƒƒã‚¯
          if [ "${{ steps.security-analysis.outputs.safety_issues }}" -gt 0 ]; then
            echo "::warning::Safety found ${{ steps.security-analysis.outputs.safety_issues }} known vulnerabilities"
            CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
          fi

          # Bandité«˜ãƒªã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
          if [ "${{ steps.security-analysis.outputs.bandit_high }}" -gt 0 ]; then
            echo "::error::Bandit found ${{ steps.security-analysis.outputs.bandit_high }} high severity security issues"
            CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
          fi

          # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºã‚’ãƒã‚§ãƒƒã‚¯
          if [ "${{ steps.security-analysis.outputs.secret_count }}" -gt 0 ]; then
            echo "::error::TruffleHog found ${{ steps.security-analysis.outputs.secret_count }} potential secrets"
            CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
          fi

          # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹é•åã‚’ãƒã‚§ãƒƒã‚¯
          if [ "${{ steps.security-analysis.outputs.license_violations }}" -gt 0 ]; then
            echo "::error::Found ${{ steps.security-analysis.outputs.license_violations }} license violations"
            CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
          fi

          if [ "$CRITICAL_ISSUES" -gt 0 ]; then
            echo "âŒ $CRITICAL_ISSUES ä»¶ã®é‡è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          else
            echo "âœ… é‡è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

  dependabot-auto-merge:
    name: Dependabot Auto-merge
    runs-on: ubuntu-latest
    if: |
      github.actor == 'dependabot[bot]' &&
      (github.event_name == 'pull_request' ||
       github.event_name == 'pull_request_review' ||
       github.event_name == 'check_suite' ||
       (github.event_name == 'workflow_dispatch' && (inputs.security_mode == 'dependabot' || inputs.security_mode == 'full')))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Analyze update type and security impact
        id: security-check
        run: |
          echo "=== Dependabotæ›´æ–°åˆ†æ ==="
          echo "ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}"
          echo "æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}"
          echo "ã‚¢ãƒ©ãƒ¼ãƒˆçŠ¶æ…‹: ${{ steps.metadata.outputs.alert-state }}"

          is_security_update=false
          auto_merge_eligible=false

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã®åˆ¤å®š
          if [[ "${{ steps.metadata.outputs.alert-state }}" == "OPEN" ]] || \
             [[ "${{ steps.metadata.outputs.alert-state }}" == "FIXED" ]]; then
            is_security_update=true
            echo "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          fi

          # æ›´æ–°ã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹è‡ªå‹•ãƒãƒ¼ã‚¸åˆ¤å®š
          case "${{ steps.metadata.outputs.update-type }}" in
            "version-update:semver-patch"|"version-update:semver-minor")
              auto_merge_eligible=true
              echo "âœ… ãƒ‘ãƒƒãƒ/ãƒã‚¤ãƒŠãƒ¼æ›´æ–°: è‡ªå‹•ãƒãƒ¼ã‚¸å¯¾è±¡"
              ;;
            "version-update:semver-major")
              auto_merge_eligible=false
              echo "âš ï¸ ãƒ¡ã‚¸ãƒ£ãƒ¼æ›´æ–°: æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦"
              ;;
          esac

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã¯å„ªå…ˆçš„ã«è‡ªå‹•ãƒãƒ¼ã‚¸
          if [[ "$is_security_update" == "true" ]]; then
            auto_merge_eligible=true
            echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã®ãŸã‚è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’æœ‰åŠ¹åŒ–"
          fi

          echo "is-security=$is_security_update" >> $GITHUB_OUTPUT
          echo "auto-merge=$auto_merge_eligible" >> $GITHUB_OUTPUT

      - name: Setup UV environment for testing
        if: steps.security-check.outputs.auto-merge == 'true'
        run: |
          uv python install ${{ env.PYTHON_VERSION }}
          uv venv --python ${{ env.PYTHON_VERSION }}
          uv sync --dev

      - name: Run compatibility tests
        if: steps.security-check.outputs.auto-merge == 'true'
        run: |
          echo "=== ä¾å­˜é–¢ä¿‚äº’æ›æ€§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ==="

          uv run python -c "
          import sys
          try:
              import setup_repo
              print('âœ… setup_repo ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ')
          except ImportError as e:
              print(f'âŒ setup_repo ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: {e}')
              sys.exit(1)
          "

      - name: Wait for required checks
        if: steps.security-check.outputs.auto-merge == 'true'
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'Security Vulnerability Scan'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          allowed-conclusions: success,neutral

      - name: Auto-approve and merge PR
        if: steps.security-check.outputs.auto-merge == 'true'
        run: |
          if [[ "${{ steps.security-check.outputs.is-security }}" == "true" ]]; then
            approval_message="ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ã®è‡ªå‹•æ‰¿èª**

            ã“ã®PRã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ä¿®æ­£ã‚’å«ã‚€ãŸã‚ã€è‡ªå‹•æ‰¿èªã•ã‚Œã¾ã—ãŸã€‚

            **æ›´æ–°å†…å®¹:**
            - ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}
            - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}

            CIãƒã‚§ãƒƒã‚¯é€šéå¾Œã«è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚"
          else
            approval_message="âœ… **ãƒ‘ãƒƒãƒ/ãƒã‚¤ãƒŠãƒ¼æ›´æ–°ã®è‡ªå‹•æ‰¿èª**

            ã“ã®PRã¯å®‰å…¨ãªæ›´æ–°ã®ãŸã‚ã€è‡ªå‹•æ‰¿èªã•ã‚Œã¾ã—ãŸã€‚

            **æ›´æ–°å†…å®¹:**
            - ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}
            - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}

            CIãƒã‚§ãƒƒã‚¯é€šéå¾Œã«è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚"
          fi

          gh pr review --approve "${{ github.event.pull_request.number }}" --body "$approval_message"

          gh pr merge --auto --squash "${{ github.event.pull_request.number }}" \
            --subject "deps: ${{ steps.metadata.outputs.dependency-names }}" \
            --body "Dependabotã«ã‚ˆã‚‹è‡ªå‹•æ›´æ–°

          **æ›´æ–°ã‚¿ã‚¤ãƒ—:** ${{ steps.metadata.outputs.update-type }}
          **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°:** ${{ steps.security-check.outputs.is-security }}

          ã“ã®PRã¯è‡ªå‹•ãƒ†ã‚¹ãƒˆã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ãŸãŸã‚ã€è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚"

          echo "âœ… è‡ªå‹•ãƒãƒ¼ã‚¸ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Handle manual review cases
        if: steps.security-check.outputs.auto-merge == 'false'
        run: |
          echo "=== æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦ãªæ›´æ–°ã®åˆ†æ ==="

          if [[ "${{ steps.security-check.outputs.is-security }}" == "true" ]]; then
            comment_body="ğŸš¨ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°ï¼ˆãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰**

            ã“ã®æ›´æ–°ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ä¿®æ­£ã‚’å«ã¿ã¾ã™ãŒã€ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã®ãŸã‚æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™ã€‚

            **âš ï¸ ç·Šæ€¥åº¦: HIGH - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚ã‚Š**

            **æ›´æ–°å†…å®¹:**
            - ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}
            - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}

            ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ãŸã‚ã€å¯èƒ½ãªé™ã‚Šè¿…é€Ÿã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚"

            gh pr edit "${{ github.event.pull_request.number }}" \
              --add-label "security,high-priority,breaking-change"
          else
            comment_body="âš ï¸ **ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°æ¤œå‡º**

            ã“ã®æ›´æ–°ã¯ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã®ãŸã‚ã€æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™ã€‚

            **æ›´æ–°å†…å®¹:**
            - ä¾å­˜é–¢ä¿‚: ${{ steps.metadata.outputs.dependency-names }}
            - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.metadata.outputs.update-type }}

            å•é¡ŒãŒãªã‘ã‚Œã°æ‰‹å‹•ã§ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚"

            gh pr edit "${{ github.event.pull_request.number }}" \
              --add-label "breaking-change,manual-review"
          fi

          gh pr comment "${{ github.event.pull_request.number }}" --body "$comment_body"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-monitor:
    name: Security Status Monitor
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 23 * * *') ||
      (github.event_name == 'workflow_dispatch' && (inputs.security_mode == 'monitor' || inputs.security_mode == 'full' || inputs.force_check == 'true'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Create virtual environment
        run: uv venv --python ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Check security advisories
        id: security-advisories
        run: |
          echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãƒã‚§ãƒƒã‚¯ ==="

          advisories=$(gh api repos/:owner/:repo/security-advisories --jq '.[] | select(.state == "published")' || echo "")

          if [[ -n "$advisories" ]]; then
            echo "open-advisories=true" >> $GITHUB_OUTPUT
            echo "ğŸš¨ ã‚ªãƒ¼ãƒ—ãƒ³ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          else
            echo "open-advisories=false" >> $GITHUB_OUTPUT
            echo "âœ… ã‚ªãƒ¼ãƒ—ãƒ³ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªã¯ã‚ã‚Šã¾ã›ã‚“"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check pending Dependabot PRs
        id: pending-prs
        run: |
          echo "=== ä¿ç•™ä¸­ã®Dependabot PRãƒã‚§ãƒƒã‚¯ ==="

          pending_prs=$(gh pr list --author "dependabot[bot]" --state open --json number,title,labels)
          security_prs=$(echo "$pending_prs" | jq '[.[] | select(.labels[]?.name == "security")]')

          pr_count=$(echo "$pending_prs" | jq 'length')
          security_pr_count=$(echo "$security_prs" | jq 'length')

          echo "pending-pr-count=$pr_count" >> $GITHUB_OUTPUT
          echo "security-pr-count=$security_pr_count" >> $GITHUB_OUTPUT

          echo "ä¿ç•™ä¸­ã®Dependabot PR: $pr_count ä»¶"
          echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£PR: $security_pr_count ä»¶"

          if [[ "$security_pr_count" -gt 0 ]]; then
            echo "security-prs-pending=true" >> $GITHUB_OUTPUT
            echo "ğŸ”´ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®PRãŒä¿ç•™ä¸­ã§ã™"
          else
            echo "security-prs-pending=false" >> $GITHUB_OUTPUT
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®PRã¯ã‚ã‚Šã¾ã›ã‚“"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run vulnerability scan
        id: vulnerability-scan
        run: |
          echo "=== ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ ==="

          if command -v safety &> /dev/null; then
            safety_result=$(uv run safety check --json || echo "[]")
            vulnerability_count=$(echo "$safety_result" | jq 'length')
          else
            vulnerability_count=0
          fi

          echo "vulnerability-count=$vulnerability_count" >> $GITHUB_OUTPUT

          if [[ "$vulnerability_count" -gt 0 ]]; then
            echo "vulnerabilities-found=true" >> $GITHUB_OUTPUT
            echo "ğŸš¨ $vulnerability_count ä»¶ã®è„†å¼±æ€§ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          else
            echo "vulnerabilities-found=false" >> $GITHUB_OUTPUT
            echo "âœ… è„†å¼±æ€§ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: Generate security status report
        run: |
          echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ ==="

          current_date=$(date '+%Y-%m-%d %H:%M:%S UTC')

          cat > security-status-report.md << EOF
          # ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ

          **ç”Ÿæˆæ—¥æ™‚:** $current_date

          ## ğŸ“Š ç¾åœ¨ã®çŠ¶æ³

          ### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒª
          - ã‚ªãƒ¼ãƒ—ãƒ³ãªã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒª: ${{ steps.security-advisories.outputs.open-advisories == 'true' && 'ğŸ”´ ã‚ã‚Š' || 'âœ… ãªã—' }}

          ### Dependabot PR
          - ä¿ç•™ä¸­ã®PRç·æ•°: ${{ steps.pending-prs.outputs.pending-pr-count }} ä»¶
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£PR: ${{ steps.pending-prs.outputs.security-pr-count }} ä»¶

          ### ä¾å­˜é–¢ä¿‚è„†å¼±æ€§
          - æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§: ${{ steps.vulnerability-scan.outputs.vulnerability-count }} ä»¶

          ## ğŸ¯ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          EOF

          if [[ "${{ steps.security-advisories.outputs.open-advisories }}" == "true" ]] || \
             [[ "${{ steps.pending-prs.outputs.security-prs-pending }}" == "true" ]] || \
             [[ "${{ steps.vulnerability-scan.outputs.vulnerabilities-found }}" == "true" ]]; then
            echo "" >> security-status-report.md
            echo "âš ï¸ **å³åº§ã®å¯¾å¿œãŒå¿…è¦ã§ã™:**" >> security-status-report.md
            echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®PRã‚’å„ªå…ˆçš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼" >> security-status-report.md
            echo "- è„†å¼±æ€§ã®ã‚ã‚‹ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°" >> security-status-report.md
            echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ" >> security-status-report.md
          else
            echo "" >> security-status-report.md
            echo "âœ… **ç¾åœ¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã¯è‰¯å¥½ã§ã™:**" >> security-status-report.md
            echo "- å®šæœŸçš„ãªç›£è¦–ã‚’ç¶™ç¶š" >> security-status-report.md
            echo "- ä¾å­˜é–¢ä¿‚ã®æœ€æ–°çŠ¶æ…‹ã‚’ç¶­æŒ" >> security-status-report.md
          fi

      - name: Create or update security status issue
        if: |
          steps.security-advisories.outputs.open-advisories == 'true' ||
          steps.pending-prs.outputs.security-prs-pending == 'true' ||
          steps.vulnerability-scan.outputs.vulnerabilities-found == 'true'
        run: |
          echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚¤ã‚·ãƒ¥ãƒ¼ã®ä½œæˆ/æ›´æ–° ==="

          existing_issue=$(gh issue list --label "security-status" --state open --json number | jq -r '.[0].number // empty')
          report_content=$(cat security-status-report.md)

          if [[ -n "$existing_issue" ]]; then
            gh issue edit "$existing_issue" --body "$report_content"
            echo "âœ… æ—¢å­˜ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚¤ã‚·ãƒ¥ãƒ¼ #$existing_issue ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
          else
            gh issue create \
              --title "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ç›£è¦–ãƒ¬ãƒãƒ¼ãƒˆ" \
              --body "$report_content" \
              --label "security-status,monitoring,automated"
            echo "âœ… æ–°ã—ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚¤ã‚·ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Close security status issue if all clear
        if: |
          steps.security-advisories.outputs.open-advisories == 'false' &&
          steps.pending-prs.outputs.security-prs-pending == 'false' &&
          steps.vulnerability-scan.outputs.vulnerabilities-found == 'false'
        run: |
          echo "=== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³è‰¯å¥½ - ã‚¤ã‚·ãƒ¥ãƒ¼ã®ã‚¯ãƒ­ãƒ¼ã‚ºç¢ºèª ==="

          existing_issue=$(gh issue list --label "security-status" --state open --json number | jq -r '.[0].number // empty')

          if [[ -n "$existing_issue" ]]; then
            gh issue close "$existing_issue" --comment "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ãŒæ”¹å–„ã•ã‚Œã¾ã—ãŸã€‚ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒè§£æ±ºã•ã‚Œã¦ã„ã¾ã™ã€‚

            **ç¢ºèªæ¸ˆã¿é …ç›®:**
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒª: ãªã—
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£PR: ãªã—
            - ä¾å­˜é–¢ä¿‚è„†å¼±æ€§: ãªã—

            å®šæœŸç›£è¦–ã¯ç¶™ç¶šã•ã‚Œã¾ã™ã€‚"
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚¤ã‚·ãƒ¥ãƒ¼ #$existing_issue ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸ"
          else
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã¯è‰¯å¥½ã§ã™ï¼ˆã‚ªãƒ¼ãƒ—ãƒ³ãªã‚¤ã‚·ãƒ¥ãƒ¼ãªã—ï¼‰"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-scan, dependabot-auto-merge, security-monitor]
    if: always()

    steps:
      - name: Download security artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-${{ github.sha }}"
          merge-multiple: true
        continue-on-error: true

      - name: Generate comprehensive security summary
        run: |
          echo "ğŸ“Š åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒãƒªãƒ¼ç”Ÿæˆä¸­..."

          cat > comprehensive-security-summary.md << 'EOF'
          # ğŸ”’ åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒãƒªãƒ¼

          ## å®Ÿè¡Œæ—¥æ™‚
          EOF

          echo "$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> comprehensive-security-summary.md
          echo "" >> comprehensive-security-summary.md

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ
          if [ -f "security-summary.md" ]; then
            echo "## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ" >> comprehensive-security-summary.md
            echo "" >> comprehensive-security-summary.md
            tail -n +3 security-summary.md >> comprehensive-security-summary.md
            echo "" >> comprehensive-security-summary.md
          fi

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–çµæœ
          if [ -f "security-status-report.md" ]; then
            echo "## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–çµæœ" >> comprehensive-security-summary.md
            echo "" >> comprehensive-security-summary.md
            tail -n +3 security-status-report.md >> comprehensive-security-summary.md
          fi

      - name: Publish security summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              let summary = '';

              if (fs.existsSync('comprehensive-security-summary.md')) {
                summary = fs.readFileSync('comprehensive-security-summary.md', 'utf8');
              } else if (fs.existsSync('security-summary.md')) {
                summary = fs.readFileSync('security-summary.md', 'utf8');
              }

              if (summary) {
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: summary
                });
              }
            } catch (error) {
              console.log('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒãƒªãƒ¼ã®æŠ•ç¨¿ã«å¤±æ•—:', error);
            }

      - name: Upload comprehensive security summary
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-security-summary-${{ github.run_number }}
          path: |
            comprehensive-security-summary.md
            security-status-report.md
          retention-days: 90
