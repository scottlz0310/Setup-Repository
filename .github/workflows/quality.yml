name: Quality Management

run-name: "Quality Management - ${{ github.event_name == 'schedule' && (github.event.schedule == '0 2 * * *' && 'Daily Metrics' || github.event.schedule == '0 0 * * *' && 'Daily Report' || github.event.schedule == '0 9 1 * *' && 'Monthly Review') || github.event_name == 'pull_request' && format('PR #{0}', github.event.number) || github.event_name == 'workflow_dispatch' && 'Manual' || github.ref_name }}"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆUTCï¼‰- ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
    - cron: "0 2 * * *"
    # æ¯æ—¥åˆå‰0æ™‚ï¼ˆUTCï¼‰- å“è³ªãƒ¬ãƒãƒ¼ãƒˆ
    - cron: "0 0 * * *"
    # æ¯æœˆ1æ—¥åˆå‰9æ™‚ï¼ˆUTCï¼‰- æœˆæ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼
    - cron: "0 9 1 * *"
  workflow_dispatch:
    inputs:
      quality_mode:
        description: "å“è³ªãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰"
        required: false
        default: "full"
        type: choice
        options:
          - "metrics"
          - "report"
          - "coverage"
          - "monthly"
          - "full"
      force_review:
        description: "å¼·åˆ¶çš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  PYTHON_VERSION: "3.11"
  # ã‚«ãƒãƒ¬ãƒƒã‚¸é—¾å€¤ã¯pyproject.tomlã§ç®¡ç†
  QUALITY_THRESHOLD: "70"

jobs:
  quality-metrics:
    name: Quality Metrics Collection
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'schedule' && github.event.schedule == '0 2 * * *') ||
      (github.event_name == 'workflow_dispatch' && (inputs.quality_mode == 'metrics' || inputs.quality_mode == 'full'))

    outputs:
      quality_score: ${{ steps.metrics.outputs.quality_score }}
      coverage: ${{ steps.metrics.outputs.coverage }}
      ruff_issues: ${{ steps.metrics.outputs.ruff_issues }}
      mypy_errors: ${{ steps.metrics.outputs.mypy_errors }}
      security_vulnerabilities: ${{ steps.metrics.outputs.security_vulnerabilities }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Create virtual environment
        run: uv venv --python ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run quality analysis
        id: metrics
        run: |
          echo "ğŸ” å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ä¸­..."

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã§ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          uv run python scripts/coverage-monitor.py --generate-report

          # ä¸¦åˆ—å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          echo "ğŸ“ å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."

          # Ruffã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
          if ! uv run ruff check . --output-format=json > ruff-report.json; then
            echo "âŒ Ruffãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
            exit 1
          fi

          # MyPyã«ã‚ˆã‚‹å‹ãƒã‚§ãƒƒã‚¯
          if ! uv run mypy src/ --no-error-summary > mypy-report.txt; then
            echo "âŒ MyPyå‹ãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
            exit 1
          fi

          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
          if ! uv run pytest tests/ \
            --json-report --json-report-file=test-report.json \
            --cov=src/setup_repo \
            --cov-report=json:coverage.json \
            --cov-report=xml \
            --cov-report=html \
            --junit-xml=test-results.xml \
            -v; then
            echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          uv run bandit -r src/ -f json -o security-report.json || echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: Generate quality metrics summary
        run: |
          echo "ğŸ“Š å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚µãƒãƒªãƒ¼ç”Ÿæˆä¸­..."

          uv run python -c "
          import json
          import os
          from datetime import datetime
          from pathlib import Path

          # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
          metrics = {
              'timestamp': datetime.now().isoformat(),
              'commit_sha': os.environ.get('GITHUB_SHA', 'unknown'),
              'branch': os.environ.get('GITHUB_REF_NAME', 'unknown'),
              'ruff_issues': 0,
              'mypy_errors': 0,
              'test_passed': 0,
              'test_failed': 0,
              'test_coverage': 0.0,
              'security_vulnerabilities': 0
          }

          # Ruffãƒ¬ãƒãƒ¼ãƒˆã‚’è§£æ
          try:
              with open('ruff-report.json', 'r') as f:
                  ruff_data = json.load(f)
              metrics['ruff_issues'] = len(ruff_data)
          except:
              pass

          # MyPyãƒ¬ãƒãƒ¼ãƒˆã‚’è§£æ
          try:
              with open('mypy-report.txt', 'r') as f:
                  mypy_lines = f.readlines()
              # ã‚¨ãƒ©ãƒ¼è¡Œã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆç°¡æ˜“çš„ï¼‰
              metrics['mypy_errors'] = len([line for line in mypy_lines if 'error:' in line])
          except:
              pass

          # ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’è§£æ
          try:
              with open('test-report.json', 'r') as f:
                  test_data = json.load(f)
              summary = test_data.get('summary', {})
              metrics['test_passed'] = summary.get('passed', 0)
              metrics['test_failed'] = summary.get('failed', 0)
          except:
              pass

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
          try:
              with open('coverage.json', 'r') as f:
                  cov_data = json.load(f)
              metrics['test_coverage'] = cov_data['totals']['percent_covered']
          except:
              pass

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’è§£æ
          try:
              with open('security-report.json', 'r') as f:
                  sec_data = json.load(f)
              metrics['security_vulnerabilities'] = len(sec_data.get('results', []))
          except:
              pass

          # å“è³ªã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
          quality_score = 100
          if metrics['test_coverage'] < 80:
              quality_score -= (80 - metrics['test_coverage']) * 2
          quality_score -= metrics['ruff_issues'] * 0.5
          quality_score -= metrics['mypy_errors'] * 1
          quality_score -= metrics['test_failed'] * 5
          quality_score -= metrics['security_vulnerabilities'] * 2
          quality_score = max(0, quality_score)
          metrics['quality_score'] = quality_score

          # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
          with open('quality-metrics.json', 'w') as f:
              json.dump(metrics, f, indent=2)

          # GitHub Actionså‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
          import os
          github_output = os.environ.get('GITHUB_OUTPUT')
          if github_output:
              with open(github_output, 'a') as f:
                  f.write(f'quality_score={quality_score:.1f}\\n')
                  f.write(f'coverage={metrics[\"test_coverage\"]:.2f}\\n')
                  f.write(f'ruff_issues={metrics[\"ruff_issues\"]}\\n')
                  f.write(f'mypy_errors={metrics[\"mypy_errors\"]}\\n')
                  f.write(f'security_vulnerabilities={metrics[\"security_vulnerabilities\"]}\\n')

          # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          print(f'quality_score={quality_score:.1f}')
          print(f'coverage={metrics[\"test_coverage\"]:.2f}')
          print(f'ruff_issues={metrics[\"ruff_issues\"]}')
          print(f'mypy_errors={metrics[\"mypy_errors\"]}')
          print(f'security_vulnerabilities={metrics[\"security_vulnerabilities\"]}')

          # ã‚µãƒãƒªãƒ¼ã‚’Markdownå½¢å¼ã§ç”Ÿæˆ
          with open('quality-summary.md', 'w') as f:
              f.write('# ğŸ“Š å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚µãƒãƒªãƒ¼\\n\\n')
              f.write(f'**å®Ÿè¡Œæ—¥æ™‚**: {metrics[\"timestamp\"]}\\n')
              f.write(f'**ã‚³ãƒŸãƒƒãƒˆ**: {metrics[\"commit_sha\"][:8]}\\n')
              f.write(f'**ãƒ–ãƒ©ãƒ³ãƒ**: {metrics[\"branch\"]}\\n\\n')

              f.write('## ãƒ¡ãƒˆãƒªã‚¯ã‚¹\\n\\n')
              f.write(f'- **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: {metrics[\"test_coverage\"]:.2f}%\\n')
              f.write(f'- **ãƒ†ã‚¹ãƒˆçµæœ**: {metrics[\"test_passed\"]} æˆåŠŸ, {metrics[\"test_failed\"]} å¤±æ•—\\n')
              f.write(f'- **Ruffå•é¡Œ**: {metrics[\"ruff_issues\"]} ä»¶\\n')
              f.write(f'- **MyPyã‚¨ãƒ©ãƒ¼**: {metrics[\"mypy_errors\"]} ä»¶\\n')
              f.write(f'- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§**: {metrics[\"security_vulnerabilities\"]} ä»¶\\n\\n')

              f.write(f'## å“è³ªã‚¹ã‚³ã‚¢: {quality_score:.1f}/100\\n\\n')

              if quality_score >= 90:
                  f.write('âœ… **å„ªç§€**: å“è³ªåŸºæº–ã‚’å¤§å¹…ã«ä¸Šå›ã£ã¦ã„ã¾ã™\\n')
              elif quality_score >= 80:
                  f.write('âœ… **è‰¯å¥½**: å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã¾ã™\\n')
              elif quality_score >= 70:
                  f.write('âš ï¸ **æ³¨æ„**: å“è³ªæ”¹å–„ãŒæ¨å¥¨ã•ã‚Œã¾ã™\\n')
              else:
                  f.write('âŒ **è¦æ”¹å–„**: å“è³ªåŸºæº–ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™\\n')

          print('å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆã—ã¾ã—ãŸ')
          "

      - name: Store metrics history
        run: |
          echo "ğŸ“ˆ ãƒ¡ãƒˆãƒªã‚¯ã‚¹å±¥æ­´ã‚’ä¿å­˜ä¸­..."

          mkdir -p quality-history

          # æ—¥ä»˜ä»˜ããƒ•ã‚¡ã‚¤ãƒ«åã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ä¿å­˜
          DATE=$(date +%Y%m%d_%H%M%S)
          cp quality-metrics.json quality-history/metrics_${DATE}.json

          # æœ€æ–°ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚æ›´æ–°
          cp quality-metrics.json quality-history/latest-metrics.json

      - name: Upload quality artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-metrics-${{ github.sha }}
          path: |
            quality-metrics.json
            quality-summary.md
            quality-history/
            ruff-report.json
            mypy-report.txt
            test-report.json
            coverage.json
            coverage.xml
            htmlcov/
            security-report.json
          retention-days: 90

  coverage-analysis:
    name: Coverage Analysis
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'schedule' && github.event.schedule == '0 0 * * *') ||
      (github.event_name == 'workflow_dispatch' && (inputs.quality_mode == 'coverage' || inputs.quality_mode == 'full'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Create virtual environment
        run: uv venv --python ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run comprehensive coverage analysis
        run: |
          echo "ğŸ” åŒ…æ‹¬çš„ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æã‚’å®Ÿè¡Œä¸­..."

          if ! uv run pytest tests/ \
            --cov=src/setup_repo \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=json \
            --junit-xml=test-results.xml \
            -v; then
            echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          if ! uv run python scripts/coverage-monitor.py --generate-report; then
            echo "âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: Generate coverage summary
        if: always()
        run: |
          echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ç”Ÿæˆä¸­..."

          if [ -f "coverage.json" ]; then
            cat > coverage-summary.md << 'EOF'
          # ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ

          ## å…¨ä½“ã‚µãƒãƒªãƒ¼
          EOF

            uv run python -c "
          import json
          from datetime import datetime

          try:
              with open('coverage.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)

              total_coverage = data['totals']['percent_covered']
              total_statements = data['totals']['num_statements']
              covered_statements = data['totals']['covered_lines']
              missing_statements = data['totals']['missing_lines']

              print(f'**å…¨ä½“ã‚«ãƒãƒ¬ãƒƒã‚¸**: {total_coverage:.2f}%')
              print(f'**ç·ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆæ•°**: {total_statements}')
              print(f'**ã‚«ãƒãƒ¼æ¸ˆã¿**: {covered_statements}')
              print(f'**æœªã‚«ãƒãƒ¼**: {missing_statements}')
              print(f'**ç”Ÿæˆæ—¥æ™‚**: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}')
              print()

              if total_coverage >= 80:
                  print('âœ… **å“è³ªã‚²ãƒ¼ãƒˆ**: é€šé (80%ä»¥ä¸Š)')
              elif total_coverage >= 70:
                  print('âš ï¸ **å“è³ªã‚²ãƒ¼ãƒˆ**: è­¦å‘Š (70%ä»¥ä¸Šã€80%æœªæº€)')
              else:
                  print('âŒ **å“è³ªã‚²ãƒ¼ãƒˆ**: æœªé”æˆ (70%æœªæº€)')

              print()
              print('## ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã‚«ãƒãƒ¬ãƒƒã‚¸')
              print()

              files = data.get('files', {})
              for filepath, file_data in sorted(files.items()):
                  if 'src/setup_repo' in filepath:
                      filename = filepath.split('/')[-1]
                      file_coverage = file_data['summary']['percent_covered']
                      status = 'âœ…' if file_coverage >= 90 else 'âš ï¸' if file_coverage >= 70 else 'âŒ'
                      print(f'{status} **{filename}**: {file_coverage:.2f}%')

          except Exception as e:
              print(f'ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆè§£æã‚¨ãƒ©ãƒ¼: {e}')
          " >> coverage-summary.md
          fi

      - name: Check coverage trend
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æä¸­..."

          set +e
          CURRENT_BRANCH=${{ github.event.pull_request.head.sha }}

          if git checkout ${{ github.event.pull_request.base.sha }}; then
            echo "âœ… ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ"

            if ! uv run pytest tests/ --cov=src/setup_repo --cov-report=json:base-coverage.json -x --tb=no -q; then
              echo "âš ï¸ ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆæ¯”è¼ƒã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ï¼‰"
              exit 0
            fi

            if git checkout $CURRENT_BRANCH; then
              if [ -f "base-coverage.json" ] && [ -f "coverage.json" ]; then
                uv run python -c "
          import json

          try:
              with open('base-coverage.json', 'r') as f:
                  base_cov = json.load(f)
              with open('coverage.json', 'r') as f:
                  current_cov = json.load(f)

              base_percent = base_cov['totals']['percent_covered']
              current_percent = current_cov['totals']['percent_covered']
              diff = current_percent - base_percent

              print(f'ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: {base_percent:.2f}%')
              print(f'ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: {current_percent:.2f}%')
              print(f'å·®åˆ†: {diff:+.2f}%')

              if diff >= 0:
                  print('âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒå‘ä¸Šã¾ãŸã¯ç¶­æŒã•ã‚Œã¦ã„ã¾ã™')
              else:
                  print('âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒä½ä¸‹ã—ã¦ã„ã¾ã™')
                  if abs(diff) > 5:
                      print('âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ5%ä»¥ä¸Šä½ä¸‹ã—ã¦ã„ã¾ã™')

              with open('coverage-trend.txt', 'w') as f:
                  f.write(f'ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: {base_percent:.2f}%\\n')
                  f.write(f'ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: {current_percent:.2f}%\\n')
                  f.write(f'å·®åˆ†: {diff:+.2f}%\\n')

          except Exception as e:
              print(f'ã‚«ãƒãƒ¬ãƒƒã‚¸æ¯”è¼ƒã«å¤±æ•—: {e}')
              with open('coverage-trend.txt', 'w') as f:
                  f.write('ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“\\n')
          "
              fi
            fi
          fi
          set -e

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-${{ github.sha }}
          path: |
            htmlcov/
            coverage.xml
            coverage.json
            coverage-summary.md
            test-results.xml
            coverage-reports/
            coverage-trend.txt
          retention-days: 30

  quality-report:
    name: Quality Report
    runs-on: ubuntu-latest
    needs: [quality-metrics, coverage-analysis]
    if: |
      always() &&
      (github.event_name == 'push' ||
       github.event_name == 'pull_request' ||
       (github.event_name == 'schedule' && github.event.schedule == '0 0 * * *') ||
       (github.event_name == 'workflow_dispatch' && (inputs.quality_mode == 'report' || inputs.quality_mode == 'full')))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download quality artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-${{ github.sha }}"
          merge-multiple: true

      - name: Generate comprehensive quality report
        run: |
          echo "ğŸ“Š åŒ…æ‹¬çš„å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."

          # å“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚’çµ±åˆ
          cat > quality-report.md << 'EOF'
          # ğŸ“Š åŒ…æ‹¬çš„å“è³ªãƒ¬ãƒãƒ¼ãƒˆ

          EOF

          # å“è³ªã‚µãƒãƒªãƒ¼ã‚’è¿½åŠ 
          if [ -f "quality-summary.md" ]; then
            cat quality-summary.md >> quality-report.md
            echo "" >> quality-report.md
          fi

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ã‚’è¿½åŠ 
          if [ -f "coverage-summary.md" ]; then
            echo "---" >> quality-report.md
            echo "" >> quality-report.md
            cat coverage-summary.md >> quality-report.md
          fi

      - name: Publish quality report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              let report = '';

              if (fs.existsSync('quality-report.md')) {
                report = fs.readFileSync('quality-report.md', 'utf8');
              } else if (fs.existsSync('quality-summary.md')) {
                report = fs.readFileSync('quality-summary.md', 'utf8');
              }

              if (report) {
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: report
                });
              }
            } catch (error) {
              console.log('å“è³ªãƒ¬ãƒãƒ¼ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—:', error);
            }

  monthly-review:
    name: Monthly Quality Review
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 9 1 * *') ||
      (github.event_name == 'workflow_dispatch' && (inputs.quality_mode == 'monthly' || inputs.force_review == 'true'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Create virtual environment
        run: uv venv --python ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Generate comprehensive monthly report
        run: |
          echo "ğŸ“Š æœˆæ¬¡å“è³ªãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."

          # å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
          uv run python scripts/quality-monitor.py --collect-metrics || echo "å“è³ªç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"

          DATE_UTC="$(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          cat > monthly-quality-report.md <<EOF
          # ğŸ“Š æœˆæ¬¡å“è³ªãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ

          **ç”Ÿæˆæ—¥æ™‚**: ${DATE_UTC}
          **ãƒ¬ãƒ“ãƒ¥ãƒ¼æœŸé–“**: éå»30æ—¥é–“

          ## ğŸ¯ å“è³ªç›®æ¨™ã®é”æˆçŠ¶æ³

          EOF

          # ç¾åœ¨ã®å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—
          if [ -f "quality-history/latest-metrics.json" ]; then
            uv run python -c "
          import json

          with open('quality-history/latest-metrics.json', 'r') as f:
              metrics = json.load(f)

          coverage = metrics.get('test_coverage', 0)
          quality_score = metrics.get('quality_score', 0)
          ruff_issues = metrics.get('ruff_issues', 0)
          mypy_errors = metrics.get('mypy_errors', 0)

          print(f'**ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: {coverage:.2f}% (ç›®æ¨™: 80%)')
          print(f'**å“è³ªã‚¹ã‚³ã‚¢**: {quality_score:.1f}/100 (ç›®æ¨™: 80)')
          print(f'**Ruffå•é¡Œ**: {ruff_issues}ä»¶ (ç›®æ¨™: â‰¤10ä»¶)')
          print(f'**MyPyã‚¨ãƒ©ãƒ¼**: {mypy_errors}ä»¶ (ç›®æ¨™: â‰¤5ä»¶)')
          print()

          goals_met = 0
          total_goals = 4

          if coverage >= 80:
              print('âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™é”æˆ')
              goals_met += 1
          else:
              print('âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™æœªé”æˆ')

          if quality_score >= 80:
              print('âœ… å“è³ªã‚¹ã‚³ã‚¢ç›®æ¨™é”æˆ')
              goals_met += 1
          else:
              print('âŒ å“è³ªã‚¹ã‚³ã‚¢ç›®æ¨™æœªé”æˆ')

          if ruff_issues <= 10:
              print('âœ… Ruffå•é¡Œç›®æ¨™é”æˆ')
              goals_met += 1
          else:
              print('âŒ Ruffå•é¡Œç›®æ¨™æœªé”æˆ')

          if mypy_errors <= 5:
              print('âœ… MyPyã‚¨ãƒ©ãƒ¼ç›®æ¨™é”æˆ')
              goals_met += 1
          else:
              print('âŒ MyPyã‚¨ãƒ©ãƒ¼ç›®æ¨™æœªé”æˆ')

          print()
          print(f'**ç›®æ¨™é”æˆç‡**: {goals_met}/{total_goals} ({goals_met/total_goals*100:.1f}%)')
          " >> monthly-quality-report.md
          else
            echo "å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“" >> monthly-quality-report.md
          fi

          echo "" >> monthly-quality-report.md
          echo "## ğŸ“‹ æ¬¡æœˆã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³" >> monthly-quality-report.md
          echo "" >> monthly-quality-report.md
          echo "1. ğŸ¯ ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¶™ç¶šçš„å‘ä¸Š" >> monthly-quality-report.md
          echo "2. ğŸ”§ å“è³ªã‚¹ã‚³ã‚¢å‘ä¸Šã®ãŸã‚ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°" >> monthly-quality-report.md
          echo "3. ğŸ§¹ ã‚³ãƒ¼ãƒ‰å“è³ªå•é¡Œã®è§£æ±º" >> monthly-quality-report.md
          echo "4. ğŸ“Š æœˆæ¬¡å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–ã®ç¶™ç¶š" >> monthly-quality-report.md

      - name: Create GitHub Issue for monthly review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const report = fs.readFileSync('monthly-quality-report.md', 'utf8');
              const currentDate = new Date().toISOString().slice(0, 7);

              const issueTitle = `æœˆæ¬¡å“è³ªãƒ¬ãƒ“ãƒ¥ãƒ¼ - ${currentDate}`;
              const issueBody = `${report}

            ## ğŸ“ é–¢é€£ãƒªãƒ³ã‚¯
            - [å“è³ªãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ## ğŸ‘¥ ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‹…å½“è€…
            @${context.repo.owner}

            ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†å¾Œã«ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„ã€‚`;

              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['quality-review', 'monthly-review', 'automated']
              });

              console.log(`æœˆæ¬¡å“è³ªãƒ¬ãƒ“ãƒ¥ãƒ¼Issueã‚’ä½œæˆã—ã¾ã—ãŸ: #${issue.data.number}`);
            } catch (error) {
              console.log('Issueä½œæˆã«å¤±æ•—:', error);
            }

      - name: Upload monthly review artifacts
        uses: actions/upload-artifact@v4
        with:
          name: monthly-quality-review-${{ github.run_number }}
          path: |
            monthly-quality-report.md
            quality-history/
          retention-days: 365

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [quality-metrics]
    if: always() && needs.quality-metrics.result != 'skipped'

    steps:
      - name: Check quality gates
        run: |
          echo "ğŸšª å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ä¸­..."

          COVERAGE="${{ needs.quality-metrics.outputs.coverage }}"
          QUALITY_SCORE="${{ needs.quality-metrics.outputs.quality_score }}"
          RUFF_ISSUES="${{ needs.quality-metrics.outputs.ruff_issues }}"
          MYPY_ERRORS="${{ needs.quality-metrics.outputs.mypy_errors }}"
          SECURITY_VULNS="${{ needs.quality-metrics.outputs.security_vulnerabilities }}"

          echo "å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹:"
          echo "  ã‚«ãƒãƒ¬ãƒƒã‚¸: ${COVERAGE}%"
          echo "  å“è³ªã‚¹ã‚³ã‚¢: ${QUALITY_SCORE}"
          echo "  Ruffå•é¡Œ: ${RUFF_ISSUES}ä»¶"
          echo "  MyPyã‚¨ãƒ©ãƒ¼: ${MYPY_ERRORS}ä»¶"
          echo "  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§: ${SECURITY_VULNS}ä»¶"

          GATE_PASSED=true

          # pyproject.tomlã‹ã‚‰ã‚«ãƒãƒ¬ãƒƒã‚¸é—¾å€¤ã‚’å–å¾—
          COVERAGE_THRESHOLD=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['tool']['coverage']['report']['fail_under'])" 2>/dev/null || echo "70")

          if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ${COVERAGE_THRESHOLD}%ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™: ${COVERAGE}%"
            GATE_PASSED=false
          fi

          if (( $(echo "$QUALITY_SCORE < ${{ env.QUALITY_THRESHOLD }}" | bc -l) )); then
            echo "âŒ å“è³ªã‚¹ã‚³ã‚¢ãŒ${{ env.QUALITY_THRESHOLD }}ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™: ${QUALITY_SCORE}"
            GATE_PASSED=false
          fi

          if [ "$RUFF_ISSUES" -gt 10 ]; then
            echo "âš ï¸ Ruffå•é¡ŒãŒå¤šã™ãã¾ã™: ${RUFF_ISSUES}ä»¶"
          fi

          if [ "$MYPY_ERRORS" -gt 5 ]; then
            echo "âš ï¸ MyPyã‚¨ãƒ©ãƒ¼ãŒå¤šã™ãã¾ã™: ${MYPY_ERRORS}ä»¶"
          fi

          if [ "$SECURITY_VULNS" -gt 0 ]; then
            echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: ${SECURITY_VULNS}ä»¶"
            GATE_PASSED=false
          fi

          if [ "$GATE_PASSED" = true ]; then
            echo "âœ… å“è³ªã‚²ãƒ¼ãƒˆã‚’é€šéã—ã¾ã—ãŸ"
          else
            echo "âŒ å“è³ªã‚²ãƒ¼ãƒˆã‚’é€šéã§ãã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi
