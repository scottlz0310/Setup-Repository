name: Coverage Report

run-name: "Coverage Report - ${{ github.event_name == 'pull_request' && format('PR #{0}', github.event.number) || github.event_name == 'workflow_dispatch' && 'Manual' || format('{0} ({1})', github.ref_name, substring(github.sha, 0, 7)) }}"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  coverage-analysis:
    name: Coverage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å±¥æ­´æ¯”è¼ƒã®ãŸã‚å…¨å±¥æ­´ã‚’å–å¾—

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Create virtual environment
        run: uv venv --python 3.11

      - name: Install dependencies
        run: uv sync --dev

      - name: Run comprehensive coverage analysis
        run: |
          echo "ğŸ” åŒ…æ‹¬çš„ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æã‚’å®Ÿè¡Œä¸­..."

          # åŸºæœ¬çš„ãªã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã¯å³åº§ã«çµ‚äº†ï¼‰
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šã‚’é–‹å§‹ã—ã¾ã™"

          if ! uv run pytest tests/ \
            --cov=src/setup_repo \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=json \
            --junit-xml=test-results.xml \
            -v; then
            echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          echo "âœ… ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ"

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -f "coverage.xml" ] && [ -f "coverage.json" ]; then
            echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
          else
            echo "âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          if ! uv run python scripts/coverage-monitor.py --generate-report; then
            echo "âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
            exit 1
          fi

          echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: Generate coverage summary
        if: always()  # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã§ã‚‚å®Ÿè¡Œ
        run: |
          echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ç”Ÿæˆä¸­..."

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          uv run python scripts/coverage-monitor.py --analyze-trends > trends.txt || echo "ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™" > trends.txt

          # åŸºæœ¬çš„ãªã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã‚’coverage.jsonã‹ã‚‰å–å¾—
          if [ -f "coverage.json" ]; then
            echo "ğŸ“‹ åŸºæœ¬ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰æƒ…å ±ã‚’ç”Ÿæˆä¸­..."

            cat > coverage-summary.md << 'EOF'
          # ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ

          ## å…¨ä½“ã‚µãƒãƒªãƒ¼
          EOF

            # coverage.jsonã‹ã‚‰åŸºæœ¬æƒ…å ±ã‚’æŠ½å‡º
            uv run python -c "
          import json
          import sys
          from datetime import datetime

          try:
              with open('coverage.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)

              total_coverage = data['totals']['percent_covered']
              total_statements = data['totals']['num_statements']
              covered_statements = data['totals']['covered_lines']
              missing_statements = data['totals']['missing_lines']

              print(f'**å…¨ä½“ã‚«ãƒãƒ¬ãƒƒã‚¸**: {total_coverage:.2f}%')
              print(f'**ç·ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆæ•°**: {total_statements}')
              print(f'**ã‚«ãƒãƒ¼æ¸ˆã¿**: {covered_statements}')
              print(f'**æœªã‚«ãƒãƒ¼**: {missing_statements}')
              print(f'**ç”Ÿæˆæ—¥æ™‚**: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}')
              print()

              # å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
              if total_coverage >= 80:
                  print('âœ… **å“è³ªã‚²ãƒ¼ãƒˆ**: é€šé (80%ä»¥ä¸Š)')
              elif total_coverage >= 70:
                  print('âš ï¸ **å“è³ªã‚²ãƒ¼ãƒˆ**: è­¦å‘Š (70%ä»¥ä¸Šã€80%æœªæº€)')
              else:
                  print('âŒ **å“è³ªã‚²ãƒ¼ãƒˆ**: æœªé”æˆ (70%æœªæº€)')

              print()
              print('## ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã‚«ãƒãƒ¬ãƒƒã‚¸')
              print()

              # ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è¡¨ç¤º
              files = data.get('files', {})
              for filepath, file_data in sorted(files.items()):
                  if 'src/setup_repo' in filepath:
                      filename = filepath.split('/')[-1]
                      file_coverage = file_data['summary']['percent_covered']
                      status = 'âœ…' if file_coverage >= 90 else 'âš ï¸' if file_coverage >= 70 else 'âŒ'
                      print(f'{status} **{filename}**: {file_coverage:.2f}%')

          except Exception as e:
              print(f'åŸºæœ¬ãƒ¬ãƒãƒ¼ãƒˆè§£æã‚¨ãƒ©ãƒ¼: {e}')
              print('ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™')
          " >> coverage-summary.md

            echo "" >> coverage-summary.md
            echo "## ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ" >> coverage-summary.md
            cat trends.txt >> coverage-summary.md

          else
            # æœ€æ–°ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            LATEST_REPORT=$(ls -t coverage-reports/coverage_report_*.json 2>/dev/null | head -n1)

            if [ -f "$LATEST_REPORT" ]; then
              echo "ğŸ“‹ è©³ç´°ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰æƒ…å ±ã‚’ç”Ÿæˆä¸­..."

              cat > coverage-summary.md << 'EOF'
          # ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ

          ## å…¨ä½“ã‚µãƒãƒªãƒ¼
          EOF

              # è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
              uv run python -c "
          import json
          import sys

          try:
              with open('$LATEST_REPORT', 'r', encoding='utf-8') as f:
                  data = json.load(f)

              coverage = data['coverage']
              req_check = data['requirements_check']
              summary = data['summary']

              print(f\"**å…¨ä½“ã‚«ãƒãƒ¬ãƒƒã‚¸**: {coverage['total_coverage']:.2f}%\")
              print(f\"**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ•°**: {summary['total_modules']}\")
              print(f\"**ç›®æ¨™é”æˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: {summary['modules_above_target']}/{summary['total_modules']}\")
              print(f\"**é‡è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç›®æ¨™é”æˆ**: {summary['critical_modules_above_target']}\")
              print()

              if req_check['passed']:
                  print('âœ… **å“è³ªã‚²ãƒ¼ãƒˆ**: é€šé')
              else:
                  print('âŒ **å“è³ªã‚²ãƒ¼ãƒˆ**: æœªé”æˆ')
                  print()
                  print('**è­¦å‘Š:**')
                  for warning in req_check['warnings']:
                      print(f'- {warning}')

              print()
              print('## ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¥ã‚«ãƒãƒ¬ãƒƒã‚¸')
              print()
              for module, cov in sorted(coverage['module_coverage'].items()):
                  status = 'âœ…' if cov >= 80 else 'âš ï¸' if cov >= 60 else 'âŒ'
                  print(f'{status} **{module}**: {cov:.2f}%')

          except Exception as e:
              print(f'è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆè§£æã‚¨ãƒ©ãƒ¼: {e}')
              print('è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™')
          " >> coverage-summary.md

              echo "" >> coverage-summary.md
              echo "## ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ" >> coverage-summary.md
              cat trends.txt >> coverage-summary.md
            else
              echo "# ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ" > coverage-summary.md
              echo "" >> coverage-summary.md
              echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" >> coverage-summary.md
              echo "ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã«å•é¡ŒãŒã‚ã£ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚" >> coverage-summary.md
            fi
          fi

          echo "ğŸ“‹ ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
          cat coverage-summary.md

      - name: Check coverage trend
        if: github.event_name == 'pull_request'

        run: |
          echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æä¸­..."

          # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®ã‚«ãƒãƒ¬ãƒƒã‚¸ã¨æ¯”è¼ƒï¼ˆã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’å¼·åŒ–ï¼‰
          set +e  # ã‚¨ãƒ©ãƒ¼ã§åœæ­¢ã—ãªã„

          # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ä¿å­˜
          CURRENT_BRANCH=${{ github.event.pull_request.head.sha }}

          # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆ
          if git checkout ${{ github.event.pull_request.base.sha }}; then
            echo "âœ… ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ"

            # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            echo "ğŸ“‹ ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã§ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šä¸­..."
            if ! uv run pytest tests/ --cov=src/setup_repo --cov-report=json:base-coverage.json -x --tb=no -q; then
              echo "âš ï¸ ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆæ¯”è¼ƒã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ï¼‰"
              echo "comparison-skipped=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã«æˆ»ã‚‹
            if git checkout $CURRENT_BRANCH; then
              echo "âœ… ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã«æˆ»ã‚Šã¾ã—ãŸ"

              # ã‚«ãƒãƒ¬ãƒƒã‚¸æ¯”è¼ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
              if [ -f "base-coverage.json" ] && [ -f "coverage.json" ]; then
                echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸æ¯”è¼ƒã‚’å®Ÿè¡Œä¸­..."

                cat > compare_coverage.py << 'EOF'
          import json
          import sys

          try:
              with open('base-coverage.json', 'r') as f:
                  base_cov = json.load(f)
              with open('coverage.json', 'r') as f:
                  current_cov = json.load(f)

              base_percent = base_cov['totals']['percent_covered']
              current_percent = current_cov['totals']['percent_covered']
              diff = current_percent - base_percent

              print(f"ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: {base_percent:.2f}%")
              print(f"ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: {current_percent:.2f}%")
              print(f"å·®åˆ†: {diff:+.2f}%")

              if diff >= 0:
                  print("âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒå‘ä¸Šã¾ãŸã¯ç¶­æŒã•ã‚Œã¦ã„ã¾ã™")
              else:
                  print("âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒä½ä¸‹ã—ã¦ã„ã¾ã™")
                  if abs(diff) > 5:
                      print("âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ5%ä»¥ä¸Šä½ä¸‹ã—ã¦ã„ã¾ã™")
                      print("::warning::ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒå¤§å¹…ã«ä½ä¸‹ã—ã¦ã„ã¾ã™ãŒã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¶™ç¶šã—ã¾ã™")
                      # sys.exit(1) ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶™ç¶š

              # ãƒˆãƒ¬ãƒ³ãƒ‰æƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
              with open('coverage-trend.txt', 'w') as f:
                  f.write(f"ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: {base_percent:.2f}%\\n")
                  f.write(f"ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: {current_percent:.2f}%\\n")
                  f.write(f"å·®åˆ†: {diff:+.2f}%\\n")

          except Exception as e:
              print(f"ã‚«ãƒãƒ¬ãƒƒã‚¸æ¯”è¼ƒã«å¤±æ•—: {e}")
              print("ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™")
              with open('coverage-trend.txt', 'w') as f:
                  f.write("ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“\\n")
          EOF

                uv run python compare_coverage.py
              else
                echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€æ¯”è¼ƒã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
                echo "ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“" > coverage-trend.txt
              fi
            else
              echo "âŒ ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã«æˆ»ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸ"
              echo "ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“" > coverage-trend.txt
            fi
          else
            echo "âŒ ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸ"
            echo "ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“" > coverage-trend.txt
          fi

          set -e  # ã‚¨ãƒ©ãƒ¼ã§åœæ­¢ã‚’å†æœ‰åŠ¹åŒ–
          echo "ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ"

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            htmlcov/
            coverage.xml
            coverage.json
            coverage-summary.md
            test-results.xml
            coverage-reports/
            coverage_badge.json
            coverage_alert.txt
            coverage-trend.txt
            trends.txt
          retention-days: 30

      - name: Publish coverage summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            try {
              const summary = fs.readFileSync('coverage-summary.md', 'utf8');

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
              console.log('ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');
            } catch (error) {
              console.log('ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ã®æŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ:', error.message);
            }

  coverage-badge:
    name: Update Coverage Badge
    runs-on: ubuntu-latest
    needs: coverage-analysis
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Create virtual environment
        run: uv venv --python 3.11

      - name: Install dependencies
        run: uv sync --dev

      - name: Generate coverage and badge
        run: |
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          uv run python scripts/coverage-monitor.py --generate-report

          # ãƒãƒƒã‚¸æƒ…å ±ã‚’å–å¾—
          if [ -f "coverage_badge.json" ]; then
            COVERAGE=$(uv run python -c "import json; data=json.load(open('coverage_badge.json')); print(data['message'].replace('%', ''))")
            COLOR=$(uv run python -c "import json; data=json.load(open('coverage_badge.json')); print(data['color'])")

            # ãƒãƒƒã‚¸URLç”Ÿæˆ
            BADGE_URL="https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR}"
            echo "Coverage badge URL: $BADGE_URL"
            echo "COVERAGE_BADGE_URL=$BADGE_URL" >> $GITHUB_ENV
          else
            echo "ãƒãƒƒã‚¸æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: Comment coverage badge
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            try {
              const badgeUrl = process.env.COVERAGE_BADGE_URL;
              const body = `## ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒãƒƒã‚¸æ›´æ–°\n\n![Coverage](${badgeUrl})\n\nãƒãƒƒã‚¸URL: \`${badgeUrl}\``;

              // æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆ
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: body
              });
              console.log('ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒãƒƒã‚¸ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');
            } catch (error) {
              console.log('ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ:', error.message);
            }
