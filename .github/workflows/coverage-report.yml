name: Coverage Report

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  coverage-analysis:
    name: Coverage Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å±¥æ­´æ¯”è¼ƒã®ãŸã‚å…¨å±¥æ­´ã‚’å–å¾—

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.11

    - name: Create virtual environment
      run: uv venv --python 3.11

    - name: Install dependencies
      run: uv sync --dev

    - name: Run comprehensive coverage analysis
      run: |
        echo "ğŸ” åŒ…æ‹¬çš„ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æã‚’å®Ÿè¡Œä¸­..."

        # è©³ç´°ãªã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        uv run pytest tests/ \
          --cov=src/setup_repo \
          --cov-report=term-missing \
          --cov-report=html:htmlcov \
          --cov-report=xml:coverage.xml \
          --cov-report=json:coverage.json \
          --cov-fail-under=80 \
          --junit-xml=test-results.xml \
          -v

    - name: Generate coverage summary
      run: |
        echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ç”Ÿæˆä¸­..."

        # ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ã‚’Markdownå½¢å¼ã§ç”Ÿæˆ
        cat > coverage-summary.md << 'EOF'
        # ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ

        ## å…¨ä½“ã‚µãƒãƒªãƒ¼
        EOF

        uv run coverage report --format=markdown >> coverage-summary.md

        echo "" >> coverage-summary.md
        echo "## è©³ç´°åˆ†æ" >> coverage-summary.md
        echo "" >> coverage-summary.md

        # æœªã‚«ãƒãƒ¼è¡Œã®è©³ç´°
        echo "### æœªã‚«ãƒãƒ¼è¡Œ" >> coverage-summary.md
        uv run coverage report --show-missing >> coverage-summary.md

        # ã‚«ãƒãƒ¬ãƒƒã‚¸å“è³ªãƒã‚§ãƒƒã‚¯
        echo "" >> coverage-summary.md
        echo "## å“è³ªã‚²ãƒ¼ãƒˆ" >> coverage-summary.md

        COVERAGE=$(uv run coverage report --format=total)
        if [ "$COVERAGE" -ge 80 ]; then
          echo "âœ… **å“è³ªã‚²ãƒ¼ãƒˆé€šé**: ${COVERAGE}% (è¦æ±‚: 80%)" >> coverage-summary.md
        else
          echo "âŒ **å“è³ªã‚²ãƒ¼ãƒˆæœªé”æˆ**: ${COVERAGE}% (è¦æ±‚: 80%)" >> coverage-summary.md
        fi

    - name: Check coverage trend
      if: github.event_name == 'pull_request'
      run: |
        echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æä¸­..."

        # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®ã‚«ãƒãƒ¬ãƒƒã‚¸ã¨æ¯”è¼ƒ
        git checkout ${{ github.event.pull_request.base.sha }}

        # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
        uv run pytest tests/ --cov=src/setup_repo --cov-report=json:base-coverage.json || true

        # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã«æˆ»ã‚‹
        git checkout ${{ github.event.pull_request.head.sha }}

        # ã‚«ãƒãƒ¬ãƒƒã‚¸æ¯”è¼ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
        cat > compare_coverage.py << 'EOF'
        import json
        import sys

        try:
            with open('base-coverage.json', 'r') as f:
                base_cov = json.load(f)
            with open('coverage.json', 'r') as f:
                current_cov = json.load(f)

            base_percent = base_cov['totals']['percent_covered']
            current_percent = current_cov['totals']['percent_covered']
            diff = current_percent - base_percent

            print(f"ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: {base_percent:.2f}%")
            print(f"ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: {current_percent:.2f}%")
            print(f"å·®åˆ†: {diff:+.2f}%")

            if diff >= 0:
                print("âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒå‘ä¸Šã¾ãŸã¯ç¶­æŒã•ã‚Œã¦ã„ã¾ã™")
            else:
                print("âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒä½ä¸‹ã—ã¦ã„ã¾ã™")
                if abs(diff) > 5:
                    print("âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ5%ä»¥ä¸Šä½ä¸‹ã—ã¦ã„ã¾ã™")
                    sys.exit(1)
        except Exception as e:
            print(f"ã‚«ãƒãƒ¬ãƒƒã‚¸æ¯”è¼ƒã«å¤±æ•—: {e}")
        EOF

        uv run python compare_coverage.py

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: |
          htmlcov/
          coverage.xml
          coverage.json
          coverage-summary.md
          test-results.xml
        retention-days: 30

    - name: Publish coverage summary
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          try {
            const summary = fs.readFileSync('coverage-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
          } catch (error) {
            console.log('ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ã®æŠ•ç¨¿ã«å¤±æ•—:', error);
          }

  coverage-badge:
    name: Update Coverage Badge
    runs-on: ubuntu-latest
    needs: coverage-analysis
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.11

    - name: Create virtual environment
      run: uv venv --python 3.11

    - name: Install dependencies
      run: uv sync --dev

    - name: Generate coverage
      run: |
        uv run pytest tests/ --cov=src/setup_repo --cov-report=json:coverage.json

    - name: Create coverage badge
      run: |
        COVERAGE=$(uv run python -c "import json; print(f\"{json.load(open('coverage.json'))['totals']['percent_covered']:.0f}\")")

        # ã‚«ãƒãƒ¬ãƒƒã‚¸ã«å¿œã˜ã¦è‰²ã‚’æ±ºå®š
        if [ "$COVERAGE" -ge 90 ]; then
          COLOR="brightgreen"
        elif [ "$COVERAGE" -ge 80 ]; then
          COLOR="green"
        elif [ "$COVERAGE" -ge 70 ]; then
          COLOR="yellow"
        elif [ "$COVERAGE" -ge 60 ]; then
          COLOR="orange"
        else
          COLOR="red"
        fi

        # ãƒãƒƒã‚¸URLç”Ÿæˆ
        BADGE_URL="https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR}"
        echo "Coverage badge URL: $BADGE_URL"

        # READMEã«ãƒãƒƒã‚¸æƒ…å ±ã‚’ä¿å­˜ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        echo "COVERAGE_BADGE_URL=$BADGE_URL" >> $GITHUB_ENV

    - name: Comment coverage badge
      uses: actions/github-script@v7
      with:
        script: |
          const badgeUrl = process.env.COVERAGE_BADGE_URL;
          const body = `## ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒãƒƒã‚¸æ›´æ–°\n\n![Coverage](${badgeUrl})\n\nãƒãƒƒã‚¸URL: \`${badgeUrl}\``;

          // æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆ
          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: body
          });
