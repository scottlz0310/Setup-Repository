name: Coverage Report

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  coverage-analysis:
    name: Coverage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å±¥æ­´æ¯”è¼ƒã®ãŸã‚å…¨å±¥æ­´ã‚’å–å¾—

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Create virtual environment
        run: uv venv --python 3.11

      - name: Install dependencies
        run: uv sync --dev

      - name: Run comprehensive coverage analysis
        run: |
          echo "ğŸ” åŒ…æ‹¬çš„ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æã‚’å®Ÿè¡Œä¸­..."

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          uv run python scripts/coverage-monitor.py --generate-report

          # è¿½åŠ ã®JUnitãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          uv run pytest tests/ --junit-xml=test-results.xml -v

      - name: Generate coverage summary
        run: |
          echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ç”Ÿæˆä¸­..."

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          uv run python scripts/coverage-monitor.py --analyze-trends > trends.txt || echo "ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™" > trends.txt

          # æœ€æ–°ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’å–å¾—
          LATEST_REPORT=$(ls -t coverage-reports/coverage_report_*.json 2>/dev/null | head -n1)

          if [ -f "$LATEST_REPORT" ]; then
            # JSONãƒ¬ãƒãƒ¼ãƒˆã‹ã‚‰Markdownã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ
            cat > coverage-summary.md << 'EOF'
          # ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ

          ## å…¨ä½“ã‚µãƒãƒªãƒ¼
          EOF

            # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦Markdownã«å¤‰æ›
            uv run python -c "
          import json
          import sys

          try:
              with open('$LATEST_REPORT', 'r', encoding='utf-8') as f:
                  data = json.load(f)

              coverage = data['coverage']
              req_check = data['requirements_check']
              summary = data['summary']

              print(f\"**å…¨ä½“ã‚«ãƒãƒ¬ãƒƒã‚¸**: {coverage['total_coverage']:.2f}%\")
              print(f\"**ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ•°**: {summary['total_modules']}\")
              print(f\"**ç›®æ¨™é”æˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: {summary['modules_above_target']}/{summary['total_modules']}\")
              print(f\"**é‡è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç›®æ¨™é”æˆ**: {summary['critical_modules_above_target']}\")
              print()

              if req_check['passed']:
                  print('âœ… **å“è³ªã‚²ãƒ¼ãƒˆ**: é€šé')
              else:
                  print('âŒ **å“è³ªã‚²ãƒ¼ãƒˆ**: æœªé”æˆ')
                  print()
                  print('**è­¦å‘Š:**')
                  for warning in req_check['warnings']:
                      print(f'- {warning}')

              print()
              print('## ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¥ã‚«ãƒãƒ¬ãƒƒã‚¸')
              print()
              for module, cov in sorted(coverage['module_coverage'].items()):
                  status = 'âœ…' if cov >= 80 else 'âš ï¸' if cov >= 60 else 'âŒ'
                  print(f'{status} **{module}**: {cov:.2f}%')

          except Exception as e:
              print(f'ãƒ¬ãƒãƒ¼ãƒˆè§£æã‚¨ãƒ©ãƒ¼: {e}')
              sys.exit(1)
          " >> coverage-summary.md

            echo "" >> coverage-summary.md
            echo "## ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ" >> coverage-summary.md
            cat trends.txt >> coverage-summary.md
          else
            echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" > coverage-summary.md
          fi

      - name: Check coverage trend
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æä¸­..."

          # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®ã‚«ãƒãƒ¬ãƒƒã‚¸ã¨æ¯”è¼ƒ
          git checkout ${{ github.event.pull_request.base.sha }}

          # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
          uv run pytest tests/ --cov=src/setup_repo --cov-report=json:base-coverage.json || true

          # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã«æˆ»ã‚‹
          git checkout ${{ github.event.pull_request.head.sha }}

          # ã‚«ãƒãƒ¬ãƒƒã‚¸æ¯”è¼ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
          cat > compare_coverage.py << 'EOF'
          import json
          import sys

          try:
              with open('base-coverage.json', 'r') as f:
                  base_cov = json.load(f)
              with open('coverage.json', 'r') as f:
                  current_cov = json.load(f)

              base_percent = base_cov['totals']['percent_covered']
              current_percent = current_cov['totals']['percent_covered']
              diff = current_percent - base_percent

              print(f"ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: {base_percent:.2f}%")
              print(f"ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: {current_percent:.2f}%")
              print(f"å·®åˆ†: {diff:+.2f}%")

              if diff >= 0:
                  print("âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒå‘ä¸Šã¾ãŸã¯ç¶­æŒã•ã‚Œã¦ã„ã¾ã™")
              else:
                  print("âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒä½ä¸‹ã—ã¦ã„ã¾ã™")
                  if abs(diff) > 5:
                      print("âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ5%ä»¥ä¸Šä½ä¸‹ã—ã¦ã„ã¾ã™")
                      sys.exit(1)
          except Exception as e:
              print(f"ã‚«ãƒãƒ¬ãƒƒã‚¸æ¯”è¼ƒã«å¤±æ•—: {e}")
          EOF

          uv run python compare_coverage.py

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            htmlcov/
            coverage.xml
            coverage.json
            coverage-summary.md
            test-results.xml
            coverage-reports/
            coverage_badge.json
            coverage_alert.txt
          retention-days: 30

      - name: Publish coverage summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const summary = fs.readFileSync('coverage-summary.md', 'utf8');

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            } catch (error) {
              console.log('ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ã®æŠ•ç¨¿ã«å¤±æ•—:', error);
            }

  coverage-badge:
    name: Update Coverage Badge
    runs-on: ubuntu-latest
    needs: coverage-analysis
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Create virtual environment
        run: uv venv --python 3.11

      - name: Install dependencies
        run: uv sync --dev

      - name: Generate coverage and badge
        run: |
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          uv run python scripts/coverage-monitor.py --generate-report

          # ãƒãƒƒã‚¸æƒ…å ±ã‚’å–å¾—
          if [ -f "coverage_badge.json" ]; then
            COVERAGE=$(uv run python -c "import json; data=json.load(open('coverage_badge.json')); print(data['message'].replace('%', ''))")
            COLOR=$(uv run python -c "import json; data=json.load(open('coverage_badge.json')); print(data['color'])")

            # ãƒãƒƒã‚¸URLç”Ÿæˆ
            BADGE_URL="https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR}"
            echo "Coverage badge URL: $BADGE_URL"
            echo "COVERAGE_BADGE_URL=$BADGE_URL" >> $GITHUB_ENV
          else
            echo "ãƒãƒƒã‚¸æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: Comment coverage badge
        uses: actions/github-script@v7
        with:
          script: |
            const badgeUrl = process.env.COVERAGE_BADGE_URL;
            const body = `## ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒãƒƒã‚¸æ›´æ–°\n\n![Coverage](${badgeUrl})\n\nãƒãƒƒã‚¸URL: \`${badgeUrl}\``;

            // æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆ
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: body
            });
