name: Quality Gate

run-name: "Quality Gate - ${{ github.event_name == 'pull_request' && format('PR #{0}', github.event.number) || 'Manual Check' }}"

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.11

    - name: Create virtual environment
      run: uv venv --python 3.11

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/uv
          .venv
        key: quality-gate-${{ hashFiles('**/pyproject.toml', '**/uv.lock') }}
        restore-keys: |
          quality-gate-

    - name: Install dependencies with reproducibility check
      run: |
        # ä¾å­˜å†ç¾æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ«ãƒ¼ãƒ«7.2æº–æ‹ ï¼‰
        echo "ä¾å­˜é–¢ä¿‚ã®å†ç¾æ€§ã‚’æ¤œè¨¼ã—ã¾ã™..."
        uv sync --dev

        # ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ç¢ºèª
        if ! uv lock --check; then
          echo "âŒ uv.lockãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ€æ–°ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        echo "âœ… ä¾å­˜é–¢ä¿‚ã®å†ç¾æ€§ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ"

    - name: Run lint checks (ruff)
      run: |
        echo "=== Ruff Lint Check ==="
        uv run ruff check . --output-format=github
        echo "âœ… Ruffãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°å®Œäº†"

    - name: Run format checks (ruff)
      run: |
        echo "=== Ruff Format Check ==="
        uv run ruff format --check .
        echo "âœ… Ruffãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯å®Œäº†"

    - name: Run type checks (mypy)
      run: |
        echo "=== MyPy Type Check ==="
        uv run mypy src/
        echo "âœ… MyPyå‹ãƒã‚§ãƒƒã‚¯å®Œäº†"

    - name: Run tests with coverage (production requirements)
      run: |
        echo "=== Test + Coverage (80%+ required) ==="
        uv run pytest tests/ \
          --cov=src/setup_repo \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-report=html \
          --cov-fail-under=80 \
          --junit-xml=test-results.xml \
          --json-report \
          --json-report-file=test-report.json \
          -n auto \
          --dist=worksteal \
          --tb=short \
          -x \
          --maxfail=5
        echo "âœ… ãƒ†ã‚¹ãƒˆ+ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼ˆ80%ä»¥ä¸Šï¼‰"

    - name: Security scan (CodeQL/SCA/Secret scan)
      run: |
        echo "=== Security Scan ==="

        # Banditã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
        if command -v bandit >/dev/null 2>&1 || uv run bandit --version >/dev/null 2>&1; then
          echo "Banditã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ..."
          uv run bandit -r src/ -f json -o bandit-report.json || echo "Banditè­¦å‘Šã‚ã‚Šï¼ˆç¶™ç¶šï¼‰"
        else
          echo "BanditãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰"
        fi

        # Safetyãƒã‚§ãƒƒã‚¯
        if command -v safety >/dev/null 2>&1 || uv run safety --version >/dev/null 2>&1; then
          echo "Safetyè„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ..."
          uv run safety scan --output json --save-as safety-report.json || echo "Safetyè­¦å‘Šã‚ã‚Šï¼ˆç¶™ç¶šï¼‰"
        else
          echo "SafetyãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰"
        fi

        echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

    - name: Secret detection check
      run: |
        echo "=== Secret Detection ==="

        # åŸºæœ¬çš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
        echo "åŸºæœ¬çš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯..."

        # APIã‚­ãƒ¼ã€ãƒˆãƒ¼ã‚¯ãƒ³ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡º
        if grep -r -E "(api[_-]?key|secret[_-]?key|password|token)" --include="*.py" --include="*.yml" --include="*.yaml" --include="*.json" src/ tests/ .github/ || true; then
          echo "âš ï¸ æ½œåœ¨çš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆæ‰‹å‹•ç¢ºèªãŒå¿…è¦ï¼‰"
        fi

        # .envãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
        if find . -name ".env*" -not -path "./.git/*" | grep -v ".env.example" | head -5; then
          echo "âŒ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆã‚³ãƒŸãƒƒãƒˆç¦æ­¢ï¼‰"
          exit 1
        fi

        echo "âœ… ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºãƒã‚§ãƒƒã‚¯å®Œäº†"

    - name: Upload quality gate results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-gate-results
        path: |
          test-results.xml
          test-report.json
          htmlcov/
          coverage.xml
          bandit-report.json
          safety-report.json
        retention-days: 30

    - name: Quality gate summary
      if: always()
      run: |
        echo "=== Quality Gate Summary ==="
        echo "âœ… ä¾å­˜å†ç¾æ€§ãƒã‚§ãƒƒã‚¯: å®Œäº†"
        echo "âœ… Ruffãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°: å®Œäº†"
        echo "âœ… Ruffãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: å®Œäº†"
        echo "âœ… MyPyå‹ãƒã‚§ãƒƒã‚¯: å®Œäº†"
        echo "âœ… ãƒ†ã‚¹ãƒˆ+ã‚«ãƒãƒ¬ãƒƒã‚¸(80%+): å®Œäº†"
        echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: å®Œäº†"
        echo "âœ… ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º: å®Œäº†"
        echo ""
        echo "ğŸ‰ å…¨ã¦ã®å“è³ªã‚²ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼"
