# ğŸš€ è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ç®¡ç†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# version-manager.pyã‚’ä½¿ç”¨ã—ãŸçµ±åˆãƒªãƒªãƒ¼ã‚¹ãƒ—ãƒ­ã‚»ã‚¹

name: ğŸš€ Release Management

run-name: "ğŸš€ Release v${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref_name }} - ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Tag Push' }}"

permissions:
  contents: write
  pull-requests: write
  issues: write
  repository-projects: write

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v1.2.3-beta.1 ãªã©ã®ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°
  workflow_dispatch:
    inputs:
      version:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (ä¾‹: 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã¨ã—ã¦ãƒãƒ¼ã‚¯'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯
  version-check:
    name: ğŸ” ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      is-prerelease: ${{ steps.extract-version.outputs.is-prerelease }}

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ uvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: false

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync --dev
          # tomli-wã¨tomliãŒç¢ºå®Ÿã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
          uv add tomli-w tomli --dev || echo "tomli dependencies already installed"

      - name: ğŸ” ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æŠ½å‡º
        id: extract-version
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_PRERELEASE: ${{ github.event.inputs.prerelease }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${INPUT_VERSION}"
            IS_PRERELEASE="${INPUT_PRERELEASE}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $VERSION"
          echo "ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹: $IS_PRERELEASE"

      - name: âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ” version-manager.pyã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ã‚’ãƒã‚§ãƒƒã‚¯"
          if ! uv run python scripts/version-manager.py --check; then
            echo "âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "ğŸ“ ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ…‹:"
            ls -la pyproject.toml src/setup_repo/__init__.py 2>/dev/null || echo "ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

  # å“è³ªãƒã‚§ãƒƒã‚¯
  quality-check:
    name: ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯
    needs: version-check
    uses: ./.github/workflows/ci.yml
    secrets: inherit
    permissions:
      actions: read
      checks: write
      contents: read
      pull-requests: write

  # è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹æº–å‚™ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆï¼‰
  prepare-release:
    name: ğŸ”§ ãƒªãƒªãƒ¼ã‚¹æº–å‚™ãƒ»è‡ªå‹•è£œå®Œ
    runs-on: ubuntu-latest
    needs: [version-check, quality-check]
    outputs:
      changes-made: ${{ steps.prepare.outputs.changes-made }}

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ uvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: false

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync --dev
          uv add tomli-w tomli --dev || echo "tomli dependencies already installed"

      - name: ğŸ”§ ãƒªãƒªãƒ¼ã‚¹æº–å‚™ãƒ»è‡ªå‹•è£œå®Œ
        id: prepare
        env:
          VERSION: ${{ needs.version-check.outputs.version }}
          IS_PRERELEASE: ${{ needs.version-check.outputs.is-prerelease }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          echo "ğŸ”§ ãƒªãƒªãƒ¼ã‚¹æº–å‚™é–‹å§‹: v$VERSION"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          CHANGES_MADE=false
          
          # 1. ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ãƒ»è‡ªå‹•ä¿®æ­£
          echo "ğŸ” ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯ãƒ»è‡ªå‹•ä¿®æ­£"
          if ! uv run python scripts/version-manager.py --check; then
            echo "ğŸ“ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸æ•´åˆã‚’æ¤œå‡º - è‡ªå‹•ä¿®æ­£ä¸­"
            if [[ "$IS_PRERELEASE" == "true" ]]; then
              uv run python scripts/version-manager.py --set "$VERSION" --prerelease
            else
              uv run python scripts/version-manager.py --set "$VERSION"
            fi
            CHANGES_MADE=true
          fi
          
          # 2. CHANGELOGè‡ªå‹•ç”Ÿæˆãƒ»æ›´æ–°
          echo "ğŸ“ CHANGELOGè‡ªå‹•ç”Ÿæˆãƒ»æ›´æ–°"
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            uv run python scripts/version-manager.py --update-changelog "$VERSION" --prerelease
          else
            uv run python scripts/version-manager.py --update-changelog "$VERSION"
          fi
          
          # 3. ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ
          echo "ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ"
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            uv run python scripts/version-manager.py --generate-notes "$VERSION" --prerelease
          else
            uv run python scripts/version-manager.py --generate-notes "$VERSION"
          fi
          
          # 4. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆå¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
          if git diff --quiet; then
            echo "âœ… å¤‰æ›´ãªã— - æ—¢ã«æº–å‚™å®Œäº†"
          else
            echo "ğŸ’¾ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­"
            git add .
            git commit -m "ğŸš€ ãƒªãƒªãƒ¼ã‚¹ v$VERSION æº–å‚™å®Œäº†
            
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ•´åˆæ€§ã‚’è‡ªå‹•ä¿®æ­£
- CHANGELOG.mdã‚’è‡ªå‹•ç”Ÿæˆãƒ»æ›´æ–°
- ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆ"
            git push origin main
            CHANGES_MADE=true
            echo "âœ… ãƒªãƒªãƒ¼ã‚¹æº–å‚™å®Œäº† - å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ"
          fi
          
          echo "changes-made=$CHANGES_MADE" >> $GITHUB_OUTPUT
          echo "ğŸ‰ ãƒªãƒªãƒ¼ã‚¹ v$VERSION ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸï¼"

  # ã‚¿ã‚°ä½œæˆãƒ»ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
  create-release:
    name: ğŸš€ ã‚¿ã‚°ä½œæˆãƒ»GitHub Releaseä½œæˆ
    runs-on: ubuntu-latest
    needs: [version-check, quality-check, prepare-release]

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ uvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: false

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ãƒ“ãƒ«ãƒ‰
        run: |
          uv sync --dev
          uv add tomli-w tomli --dev || echo "tomli dependencies already installed"
          uv build

      - name: ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        env:
          VERSION: ${{ needs.version-check.outputs.version }}
          IS_PRERELEASE: ${{ needs.version-check.outputs.is-prerelease }}
        run: |
          echo "ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            uv run python scripts/version-manager.py --generate-notes "$VERSION" --prerelease
          else
            uv run python scripts/version-manager.py --generate-notes "$VERSION"
          fi

      - name: ğŸ·ï¸ ã‚¿ã‚°ä½œæˆï¼ˆæ‰‹å‹•ãƒªãƒªãƒ¼ã‚¹æ™‚ã®ã¿ï¼‰
        if: github.event_name == 'workflow_dispatch'
        env:
          VERSION: ${{ needs.version-check.outputs.version }}
        run: |
          echo "ğŸ·ï¸ ã‚¿ã‚° v$VERSION ã‚’ä½œæˆ"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag "v$VERSION"
          git push origin "v$VERSION"
          echo "âœ… ã‚¿ã‚° v$VERSION ã‚’ä½œæˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"

      - name: ğŸš€ GitHub Releaseã‚’ä½œæˆ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version-check.outputs.version }}
          name: ğŸš€ Setup Repository v${{ needs.version-check.outputs.version }}
          body_path: release-notes.md
          prerelease: ${{ needs.version-check.outputs.is-prerelease == 'true' }}
          draft: false
          files: |
            dist/*
            CHANGELOG.md
            README.md
            LICENSE
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¢ ãƒªãƒªãƒ¼ã‚¹å®Œäº†é€šçŸ¥
        env:
          VERSION: ${{ needs.version-check.outputs.version }}
          REPOSITORY: ${{ github.repository }}
        run: |
          echo "ğŸ‰ ãƒªãƒªãƒ¼ã‚¹ v$VERSION ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼"
          echo "ğŸ“¦ ã‚¢ã‚»ãƒƒãƒˆ: $(ls -la dist/)"
          echo "ğŸ”— ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸: https://github.com/$REPOSITORY/releases/tag/v$VERSION"

  # ãƒªãƒªãƒ¼ã‚¹å¾Œå‡¦ç†
  post-release:
    name: ğŸ§¹ ãƒªãƒªãƒ¼ã‚¹å¾Œå‡¦ç†
    runs-on: ubuntu-latest
    needs: [version-check, create-release, prepare-release]
    if: always() && needs.create-release.result == 'success'

    steps:
      - name: ğŸ“Š ãƒªãƒªãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¨˜éŒ²
        env:
          VERSION: ${{ needs.version-check.outputs.version }}
          IS_PRERELEASE: ${{ needs.version-check.outputs.is-prerelease }}
          COMMIT_SHA: ${{ github.sha }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          echo "ğŸ“Š ãƒªãƒªãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹:"
          echo "  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $VERSION"
          echo "  - ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹: $IS_PRERELEASE"
          echo "  - ãƒªãƒªãƒ¼ã‚¹æ—¥æ™‚: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "  - ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: $COMMIT_SHA"
          echo "  - ãƒˆãƒªã‚¬ãƒ¼: $EVENT_NAME"
