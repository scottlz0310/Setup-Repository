# ğŸš€ è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ç®¡ç†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ã‚¿ã‚°ãƒ™ãƒ¼ã‚¹ã®è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ã€CHANGELOGæ›´æ–°ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ã€GitHub Releasesä½œæˆ

name: ğŸš€ Release Management

run-name: "ğŸš€ Release v${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref_name }} - ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Tag Push' }}"

permissions:
  contents: write
  pull-requests: write
  issues: write
  repository-projects: write

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v1.2.3-beta.1 ãªã©ã®ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°
  workflow_dispatch:
    inputs:
      version:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (ä¾‹: 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã¨ã—ã¦ãƒãƒ¼ã‚¯'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯
  version-consistency-check:
    name: ğŸ” ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      is-prerelease: ${{ steps.extract-version.outputs.is-prerelease }}

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆCHANGELOGç”Ÿæˆã®ãŸã‚ï¼‰

      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ uvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: false

      - name: ğŸ“¦ å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install tomli

      - name: ğŸ” ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æŠ½å‡º
        id: extract-version
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_PRERELEASE: ${{ github.event.inputs.prerelease }}
        run: |
          # å…¥åŠ›å€¤ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # ç’°å¢ƒå¤‰æ•°çµŒç”±ã§å®‰å…¨ã«å€¤ã‚’å–å¾—
            RAW_VERSION="${INPUT_VERSION}"
            VERSION=$(echo "$RAW_VERSION" | sed 's/[^a-zA-Z0-9.-]//g')

            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³å½¢å¼ã®æ¤œè¨¼
            if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta|rc)\.[0-9]+)?$ ]]; then
              echo "ç„¡åŠ¹ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³å½¢å¼: $VERSION"
              exit 1
            fi

            IS_PRERELEASE="${INPUT_PRERELEASE}"
          else
            # ã‚¿ã‚°ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡º (v1.0.0 -> 1.0.0)
            RAW_TAG="${GITHUB_REF#refs/tags/v}"
            VERSION=$(echo "$RAW_TAG" | sed 's/[^a-zA-Z0-9.-]//g')

            # ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã‹ã©ã†ã‹ã‚’åˆ¤å®š (alpha, beta, rc ã‚’å«ã‚€å ´åˆ)
            if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $VERSION"
          echo "ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹: $IS_PRERELEASE"

      - name: ğŸ“‹ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
        run: |
          cat > scripts/version-check.py << 'EOF'
          #!/usr/bin/env python3
          """ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã®ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ"""

          import sys
          import re
          from pathlib import Path
          try:
              import tomllib
          except ImportError:
              import tomli as tomllib

          def check_version_consistency(expected_version: str) -> bool:
              """å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒä¸€è²«ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯"""
              errors = []

              # pyproject.tomlã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
              try:
                  with open("pyproject.toml", "rb") as f:
                      pyproject_data = tomllib.load(f)
                  pyproject_version = pyproject_data["project"]["version"]
                  if pyproject_version != expected_version:
                      errors.append(f"pyproject.toml: {pyproject_version} != {expected_version}")
              except Exception as e:
                  errors.append(f"pyproject.tomlèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")

              # __init__.pyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
              init_file = Path("src/setup_repo/__init__.py")
              if init_file.exists():
                  try:
                      content = init_file.read_text(encoding="utf-8")
                      version_match = re.search(r'__version__\s*=\s*["\']([^"\']+)["\']', content)
                      if version_match:
                          init_version = version_match.group(1)
                          if init_version != expected_version:
                              errors.append(f"__init__.py: {init_version} != {expected_version}")
                      else:
                          errors.append("__init__.py: __version__ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                  except Exception as e:
                      errors.append(f"__init__.pyèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")

              if errors:
                  print("âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸æ•´åˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:")
                  for error in errors:
                      print(f"  - {error}")
                  return False
              else:
                  print(f"âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯å®Œäº†: {expected_version}")
                  return True

          if __name__ == "__main__":
              if len(sys.argv) != 2:
                  print("ä½¿ç”¨æ³•: python version-check.py <expected_version>")
                  sys.exit(1)

              expected_version = sys.argv[1]
              if not check_version_consistency(expected_version):
                  sys.exit(1)
          EOF

          chmod +x scripts/version-check.py

      - name: âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ã‚’æ¤œè¨¼
        env:
          VERSION: ${{ steps.extract-version.outputs.version }}
        run: |
          python scripts/version-check.py "$VERSION"

  # å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜ã®CIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†åˆ©ç”¨ï¼‰
  quality-check:
    name: ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯
    needs: version-consistency-check
    uses: ./.github/workflows/ci.yml
    secrets: inherit
    permissions:
      actions: read
      checks: write
      contents: read
      pull-requests: write

  # CHANGELOG.mdã®è‡ªå‹•æ›´æ–°
  update-changelog:
    name: ğŸ“ CHANGELOGæ›´æ–°
    runs-on: ubuntu-latest
    needs: [version-consistency-check, quality-check]
    outputs:
      changelog-updated: ${{ steps.update-changelog.outputs.updated }}

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“ CHANGELOGæ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
        run: |
          cat > scripts/update-changelog.py << 'EOF'
          #!/usr/bin/env python3
          """CHANGELOG.mdã®è‡ªå‹•æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ"""

          import sys
          import re
          from datetime import datetime
          from pathlib import Path
          import subprocess

          def get_git_commits_since_last_tag(version: str) -> list[str]:
              """å‰å›ã®ã‚¿ã‚°ä»¥é™ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—"""
              try:
                  # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
                  result = subprocess.run(
                      ["git", "describe", "--tags", "--abbrev=0", "HEAD~1"],
                      capture_output=True, text=True, check=False
                  )

                  if result.returncode == 0:
                      last_tag = result.stdout.strip()
                      # å‰å›ã®ã‚¿ã‚°ä»¥é™ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
                      result = subprocess.run(
                          ["git", "log", f"{last_tag}..HEAD", "--pretty=format:%s"],
                          capture_output=True, text=True, check=True
                      )
                  else:
                      # åˆå›ãƒªãƒªãƒ¼ã‚¹ã®å ´åˆã€å…¨ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
                      result = subprocess.run(
                          ["git", "log", "--pretty=format:%s"],
                          capture_output=True, text=True, check=True
                      )

                  commits = [line.strip() for line in result.stdout.split('\n') if line.strip()]
                  return commits
              except subprocess.CalledProcessError:
                  return []

          def categorize_commits(commits: list[str]) -> dict[str, list[str]]:
              """ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«åˆ†é¡"""
              categories = {
                  "âœ¨ è¿½åŠ ": [],
                  "ğŸ”„ å¤‰æ›´": [],
                  "ğŸ› ä¿®æ­£": [],
                  "ğŸ—‘ï¸ å‰Šé™¤": [],
                  "ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ": [],
                  "ğŸ”§ ãã®ä»–": []
              }

              for commit in commits:
                  # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
                  if re.match(r'^(feat|add|new):', commit, re.IGNORECASE):
                      categories["âœ¨ è¿½åŠ "].append(commit)
                  elif re.match(r'^(fix|bug):', commit, re.IGNORECASE):
                      categories["ğŸ› ä¿®æ­£"].append(commit)
                  elif re.match(r'^(change|update|modify):', commit, re.IGNORECASE):
                      categories["ğŸ”„ å¤‰æ›´"].append(commit)
                  elif re.match(r'^(remove|delete):', commit, re.IGNORECASE):
                      categories["ğŸ—‘ï¸ å‰Šé™¤"].append(commit)
                  elif re.match(r'^(doc|docs):', commit, re.IGNORECASE):
                      categories["ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"].append(commit)
                  elif any(keyword in commit.lower() for keyword in ['feat', 'add', 'new', 'è¿½åŠ ', 'æ–°è¦']):
                      categories["âœ¨ è¿½åŠ "].append(commit)
                  elif any(keyword in commit.lower() for keyword in ['fix', 'bug', 'ä¿®æ­£', 'ãƒã‚°']):
                      categories["ğŸ› ä¿®æ­£"].append(commit)
                  elif any(keyword in commit.lower() for keyword in ['change', 'update', 'å¤‰æ›´', 'æ›´æ–°']):
                      categories["ğŸ”„ å¤‰æ›´"].append(commit)
                  elif any(keyword in commit.lower() for keyword in ['doc', 'readme', 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ']):
                      categories["ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"].append(commit)
                  else:
                      categories["ğŸ”§ ãã®ä»–"].append(commit)

              return categories

          def update_changelog(version: str, is_prerelease: bool) -> bool:
              """CHANGELOG.mdã‚’æ›´æ–°"""
              changelog_path = Path("CHANGELOG.md")

              if not changelog_path.exists():
                  print("CHANGELOG.mdãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¾ã™ã€‚")
                  changelog_content = "# ğŸ“ å¤‰æ›´å±¥æ­´\n\n"
              else:
                  changelog_content = changelog_path.read_text(encoding="utf-8")

              # æ—¢ã«åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              if f"## [{version}]" in changelog_content:
                  print(f"ãƒãƒ¼ã‚¸ãƒ§ãƒ³ {version} ã¯æ—¢ã«CHANGELOGã«å­˜åœ¨ã—ã¾ã™ã€‚")
                  return False

              # ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’å–å¾—ã—ã¦ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘
              commits = get_git_commits_since_last_tag(version)
              if not commits:
                  print("æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
                  return False

              categories = categorize_commits(commits)

              # æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆ
              today = datetime.now().strftime("%Y-%m-%d")
              prerelease_tag = " (ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹)" if is_prerelease else ""
              new_entry = f"\n## [{version}]{prerelease_tag} - {today}\n\n"

              # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
              for category, items in categories.items():
                  if items:
                      new_entry += f"### {category}\n"
                      for item in items:
                          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                          clean_item = re.sub(r'^(feat|fix|add|change|update|doc|docs):\s*', '', item, flags=re.IGNORECASE)
                          new_entry += f"- {clean_item}\n"
                      new_entry += "\n"

              # CHANGELOGã«æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’æŒ¿å…¥
              lines = changelog_content.split('\n')
              header_found = False
              insert_index = len(lines)

              for i, line in enumerate(lines):
                  if line.startswith('# ') and not header_found:
                      header_found = True
                      continue
                  if header_found and (line.startswith('## ') or i == len(lines) - 1):
                      insert_index = i
                      break

              # æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’æŒ¿å…¥
              lines.insert(insert_index, new_entry.rstrip())
              updated_content = '\n'.join(lines)

              # ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
              changelog_path.write_text(updated_content, encoding="utf-8")
              print(f"âœ… CHANGELOG.mdã‚’æ›´æ–°ã—ã¾ã—ãŸ (ãƒãƒ¼ã‚¸ãƒ§ãƒ³: {version})")
              return True

          if __name__ == "__main__":
              if len(sys.argv) != 3:
                  print("ä½¿ç”¨æ³•: python update-changelog.py <version> <is_prerelease>")
                  sys.exit(1)

              version = sys.argv[1]
              is_prerelease = sys.argv[2].lower() == "true"

              if update_changelog(version, is_prerelease):
                  print("updated=true")
              else:
                  print("updated=false")
          EOF

          chmod +x scripts/update-changelog.py

      - name: ğŸ“ CHANGELOGã‚’æ›´æ–°
        id: update-changelog
        env:
          VERSION: ${{ needs.version-consistency-check.outputs.version }}
          IS_PRERELEASE: ${{ needs.version-consistency-check.outputs.is-prerelease }}
        run: |
          result=$(python scripts/update-changelog.py "$VERSION" "$IS_PRERELEASE")
          echo "updated=${result##*=}" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ CHANGELOGå¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: steps.update-changelog.outputs.updated == 'true'
        env:
          VERSION: ${{ needs.version-consistency-check.outputs.version }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          git commit -m "ğŸ“ CHANGELOG.mdã‚’æ›´æ–°: v$VERSION"
          git push

  # GitHub Releasesã®è‡ªå‹•ä½œæˆ
  create-github-release:
    name: ğŸš€ GitHub Releaseä½œæˆ
    runs-on: ubuntu-latest
    needs: [version-consistency-check, quality-check, update-changelog]

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ uvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: false

      - name: ğŸ—ï¸ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
        run: |
          uv sync --dev
          uv build

      - name: ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        id: release-notes
        run: |
          cat > scripts/generate-release-notes.py << 'EOF'
          #!/usr/bin/env python3
          """ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ"""

          import sys
          import re
          from pathlib import Path

          def extract_changelog_section(version: str) -> str:
              """CHANGELOG.mdã‹ã‚‰æŒ‡å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º"""
              changelog_path = Path("CHANGELOG.md")

              if not changelog_path.exists():
                  return f"ãƒãƒ¼ã‚¸ãƒ§ãƒ³ {version} ã®ãƒªãƒªãƒ¼ã‚¹ã§ã™ã€‚"

              content = changelog_path.read_text(encoding="utf-8")
              lines = content.split('\n')

              # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¢ã™
              start_index = None
              end_index = None

              for i, line in enumerate(lines):
                  if f"## [{version}]" in line:
                      start_index = i + 1
                  elif start_index is not None and line.startswith('## ['):
                      end_index = i
                      break

              if start_index is None:
                  return f"ãƒãƒ¼ã‚¸ãƒ§ãƒ³ {version} ã®ãƒªãƒªãƒ¼ã‚¹ã§ã™ã€‚"

              if end_index is None:
                  end_index = len(lines)

              # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’æŠ½å‡º
              section_lines = lines[start_index:end_index]
              section_content = '\n'.join(section_lines).strip()

              if not section_content:
                  return f"ãƒãƒ¼ã‚¸ãƒ§ãƒ³ {version} ã®ãƒªãƒªãƒ¼ã‚¹ã§ã™ã€‚"

              return section_content

          def generate_release_notes(version: str, is_prerelease: bool) -> str:
              """ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"""
              changelog_section = extract_changelog_section(version)

              prerelease_notice = ""
              if is_prerelease:
                  prerelease_notice = """
          > **âš ï¸ ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ç‰ˆã§ã™**
          > ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ãƒ†ã‚¹ãƒˆç›®çš„ã§ã‚ã‚Šã€æœ¬ç•ªç’°å¢ƒã§ã®ä½¿ç”¨ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚

          """

              release_notes = f"""# ğŸš€ Setup Repository v{version}

          {prerelease_notice}## ğŸ“‹ å¤‰æ›´å†…å®¹

          {changelog_section}

          ## ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

          ### ğŸ Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦
          ```bash
          pip install setup-repository
          ```

          ### ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          ```bash
          git clone https://github.com/scottlz0310/Setup-Repository.git
          cd Setup-Repository
          uv sync --dev
          uv run main.py setup
          ```

          ## ğŸ”§ ä½¿ç”¨æ–¹æ³•

          ```bash
          # åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          setup-repo setup

          # ãƒªãƒã‚¸ãƒˆãƒªåŒæœŸ
          setup-repo sync

          # ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰
          setup-repo sync --dry-run
          ```

          ## ğŸŒ ã‚µãƒãƒ¼ãƒˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 

          - âœ… Windows (Scoop, Winget, Chocolatey)
          - âœ… Linux (Snap, APT)
          - âœ… WSL (Linuxäº’æ›)
          - âœ… macOS (Homebrew)

          ## ğŸ Pythonè¦ä»¶

          - Python 3.9ä»¥ä¸Š
          - å¯¾å¿œãƒãƒ¼ã‚¸ãƒ§ãƒ³: 3.9, 3.10, 3.11, 3.12, 3.13

          ---

          **å®Œå…¨ãªå¤‰æ›´å±¥æ­´**: [CHANGELOG.md](https://github.com/scottlz0310/Setup-Repository/blob/main/CHANGELOG.md)
          """

              return release_notes

          if __name__ == "__main__":
              if len(sys.argv) != 3:
                  print("ä½¿ç”¨æ³•: python generate-release-notes.py <version> <is_prerelease>")
                  sys.exit(1)

              version = sys.argv[1]
              is_prerelease = sys.argv[2].lower() == "true"

              notes = generate_release_notes(version, is_prerelease)

              # GitHub Actionsã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
              with open("release-notes.md", "w", encoding="utf-8") as f:
                  f.write(notes)

              print("âœ… ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ")
          EOF

          chmod +x scripts/generate-release-notes.py

      - name: ğŸ“ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆå®Ÿè¡Œ
        env:
          VERSION: ${{ needs.version-consistency-check.outputs.version }}
          IS_PRERELEASE: ${{ needs.version-consistency-check.outputs.is-prerelease }}
        run: |
          python scripts/generate-release-notes.py "$VERSION" "$IS_PRERELEASE"

      - name: ğŸš€ GitHub Releaseã‚’ä½œæˆ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version-consistency-check.outputs.version }}
          name: ğŸš€ Setup Repository v${{ needs.version-consistency-check.outputs.version }}
          body_path: release-notes.md
          prerelease: ${{ needs.version-consistency-check.outputs.is-prerelease == 'true' }}
          draft: false
          files: |
            dist/*
            CHANGELOG.md
            README.md
            LICENSE
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¢ ãƒªãƒªãƒ¼ã‚¹å®Œäº†é€šçŸ¥
        env:
          VERSION: ${{ needs.version-consistency-check.outputs.version }}
          REPOSITORY: ${{ github.repository }}
        run: |
          echo "ğŸ‰ ãƒªãƒªãƒ¼ã‚¹ v$VERSION ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼"
          echo "ğŸ“¦ ã‚¢ã‚»ãƒƒãƒˆ: $(ls -la dist/)"
          echo "ğŸ”— ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸: https://github.com/$REPOSITORY/releases/tag/v$VERSION"

  # ãƒªãƒªãƒ¼ã‚¹å¾Œã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  post-release:
    name: ğŸ§¹ ãƒªãƒªãƒ¼ã‚¹å¾Œå‡¦ç†
    runs-on: ubuntu-latest
    needs: [version-consistency-check, create-github-release]
    if: always() && needs.create-github-release.result == 'success'

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ“Š ãƒªãƒªãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¨˜éŒ²
        env:
          VERSION: ${{ needs.version-consistency-check.outputs.version }}
          IS_PRERELEASE: ${{ needs.version-consistency-check.outputs.is-prerelease }}
          COMMIT_SHA: ${{ github.sha }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          echo "ğŸ“Š ãƒªãƒªãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹:"
          echo "  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $VERSION"
          echo "  - ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹: $IS_PRERELEASE"
          echo "  - ãƒªãƒªãƒ¼ã‚¹æ—¥æ™‚: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "  - ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: $COMMIT_SHA"
          echo "  - ãƒˆãƒªã‚¬ãƒ¼: $EVENT_NAME"

      - name: ğŸ·ï¸ æ¬¡å›é–‹ç™ºãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æº–å‚™
        if: needs.version-consistency-check.outputs.is-prerelease == 'false'
        run: |
          echo "ğŸ”„ æ¬¡å›é–‹ç™ºãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æº–å‚™ã‚’é–‹å§‹..."
          # å°†æ¥çš„ã«ã¯ã“ã“ã§é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆã‚„æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æº–å‚™ã‚’è¡Œã†
          echo "âœ… æ¬¡å›é–‹ç™ºãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æº–å‚™å®Œäº†"
