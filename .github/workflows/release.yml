# ğŸš€ è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ç®¡ç†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# version-manager.pyã‚’ä½¿ç”¨ã—ãŸçµ±åˆãƒªãƒªãƒ¼ã‚¹ãƒ—ãƒ­ã‚»ã‚¹

name: ğŸš€ Release Management

run-name: "ğŸš€ Release v${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.ref_name }} - ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Tag Push' }}"

permissions:
  contents: write
  pull-requests: write
  issues: write
  repository-projects: write

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v1.2.3-beta.1 ãªã©ã®ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°
  workflow_dispatch:
    inputs:
      version:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (ä¾‹: 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã¨ã—ã¦ãƒãƒ¼ã‚¯'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯
  version-check:
    name: ğŸ” ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      is-prerelease: ${{ steps.extract-version.outputs.is-prerelease }}

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ uvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: false

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          uv sync --dev
          # tomli-wã¨tomliãŒç¢ºå®Ÿã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
          uv add tomli-w tomli --dev || echo "tomli dependencies already installed"

      - name: ğŸ” ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æŠ½å‡º
        id: extract-version
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_PRERELEASE: ${{ github.event.inputs.prerelease }}
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${INPUT_VERSION}"
            IS_PRERELEASE="${INPUT_PRERELEASE}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $VERSION"
          echo "ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹: $IS_PRERELEASE"

      - name: âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ” version-manager.pyã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ã‚’ãƒã‚§ãƒƒã‚¯"
          if ! uv run python scripts/version-manager.py --check; then
            echo "âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è²«æ€§ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "ğŸ“ ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ…‹:"
            ls -la pyproject.toml src/setup_repo/__init__.py 2>/dev/null || echo "ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

  # å“è³ªãƒã‚§ãƒƒã‚¯
  quality-check:
    name: ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯
    needs: version-check
    uses: ./.github/workflows/ci.yml
    secrets: inherit
    permissions:
      actions: read
      checks: write
      contents: read
      pull-requests: write

  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
  create-release:
    name: ğŸš€ GitHub Releaseä½œæˆ
    runs-on: ubuntu-latest
    needs: [version-check, quality-check]

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ uvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: false

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ãƒ“ãƒ«ãƒ‰
        run: |
          uv sync --dev
          # tomli-wã¨tomliãŒç¢ºå®Ÿã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
          uv add tomli-w tomli --dev || echo "tomli dependencies already installed"
          uv build

      - name: ğŸ“ CHANGELOGæ—¥ä»˜ã‚’æ›´æ–°
        env:
          VERSION: ${{ needs.version-check.outputs.version }}
          IS_PRERELEASE: ${{ needs.version-check.outputs.is-prerelease }}
        run: |
          echo "ğŸ“ CHANGELOG.mdã®æ—¥ä»˜ã‚’æ›´æ–°"
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            uv run python scripts/version-manager.py --update-changelog "$VERSION" --prerelease
          else
            uv run python scripts/version-manager.py --update-changelog "$VERSION"
          fi

      - name: ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
        env:
          VERSION: ${{ needs.version-check.outputs.version }}
          IS_PRERELEASE: ${{ needs.version-check.outputs.is-prerelease }}
        run: |
          echo "ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            uv run python scripts/version-manager.py --generate-notes "$VERSION" --prerelease
          else
            uv run python scripts/version-manager.py --generate-notes "$VERSION"
          fi

      - name: ğŸ’¾ CHANGELOGå¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        env:
          VERSION: ${{ needs.version-check.outputs.version }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          if git diff --quiet CHANGELOG.md; then
            echo "CHANGELOG.mdã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          else
            git add CHANGELOG.md
            git commit -m "ğŸ“ CHANGELOG.mdã‚’æ›´æ–°: v$VERSION"
            git push
          fi

      - name: ğŸš€ GitHub Releaseã‚’ä½œæˆ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version-check.outputs.version }}
          name: ğŸš€ Setup Repository v${{ needs.version-check.outputs.version }}
          body_path: release-notes.md
          prerelease: ${{ needs.version-check.outputs.is-prerelease == 'true' }}
          draft: false
          files: |
            dist/*
            CHANGELOG.md
            README.md
            LICENSE
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¢ ãƒªãƒªãƒ¼ã‚¹å®Œäº†é€šçŸ¥
        env:
          VERSION: ${{ needs.version-check.outputs.version }}
          REPOSITORY: ${{ github.repository }}
        run: |
          echo "ğŸ‰ ãƒªãƒªãƒ¼ã‚¹ v$VERSION ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼"
          echo "ğŸ“¦ ã‚¢ã‚»ãƒƒãƒˆ: $(ls -la dist/)"
          echo "ğŸ”— ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸: https://github.com/$REPOSITORY/releases/tag/v$VERSION"

  # ãƒªãƒªãƒ¼ã‚¹å¾Œå‡¦ç†
  post-release:
    name: ğŸ§¹ ãƒªãƒªãƒ¼ã‚¹å¾Œå‡¦ç†
    runs-on: ubuntu-latest
    needs: [version-check, create-release]
    if: always() && needs.create-release.result == 'success'

    steps:
      - name: ğŸ“Š ãƒªãƒªãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¨˜éŒ²
        env:
          VERSION: ${{ needs.version-check.outputs.version }}
          IS_PRERELEASE: ${{ needs.version-check.outputs.is-prerelease }}
          COMMIT_SHA: ${{ github.sha }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          echo "ğŸ“Š ãƒªãƒªãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹:"
          echo "  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $VERSION"
          echo "  - ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹: $IS_PRERELEASE"
          echo "  - ãƒªãƒªãƒ¼ã‚¹æ—¥æ™‚: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "  - ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥: $COMMIT_SHA"
          echo "  - ãƒˆãƒªã‚¬ãƒ¼: $EVENT_NAME"
