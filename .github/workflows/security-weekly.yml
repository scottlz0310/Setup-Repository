name: Weekly Security Scan

run-name: "Weekly Security Scan - ${{ github.event_name == 'schedule' && 'Scheduled' || 'Manual' }}"

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥åˆå‰2æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 2 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  safety-scan:
    name: Safety Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Create virtual environment
        run: uv venv --python ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Install Safety
        run: uv pip install safety

      - name: Export requirements for Safety
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­..."
          uv export --no-hashes -o requirements.txt
          echo "âœ… requirements.txt ã‚’ç”Ÿæˆã—ã¾ã—ãŸ"

      - name: Run Safety scan
        id: safety
        env:
          SAFETY_API_KEY: ${{ secrets.SAFETY_API_KEY }}
        run: |
          echo "ğŸ” Safetyè„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œä¸­..."

          # Safetyã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œï¼ˆãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ï¼‰
          set +e
          uv run safety check -r requirements.txt --output text > safety-report.txt 2>&1
          SAFETY_EXIT_CODE=$?
          set -e

          # çµæœã‚’è¡¨ç¤º
          cat safety-report.txt

          # è„†å¼±æ€§ã‚«ã‚¦ãƒ³ãƒˆï¼ˆç°¡æ˜“çš„ãªãƒ‘ãƒ¼ã‚¹ï¼‰
          if [ $SAFETY_EXIT_CODE -eq 0 ]; then
            echo "âœ… è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            echo "vulnerabilities=0" >> $GITHUB_OUTPUT
          else
            # è„†å¼±æ€§æ¤œå‡ºæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ"found X vulnerabilities"ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¢ã™ï¼‰
            # yamllint disable-line rule:line-length
            VULN_COUNT=$(grep -oP '\d+(?= known security vulnerabilit)' safety-report.txt 2>/dev/null | head -1 || echo "1")
            echo "vulnerabilities=$VULN_COUNT" >> $GITHUB_OUTPUT
            echo "âš ï¸ $VULN_COUNT ä»¶ã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          fi

      - name: Upload Safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-report
          path: |
            safety-report.txt
            requirements.txt
          retention-days: 90

      - name: Create or update security issue
        if: steps.safety.outputs.vulnerabilities != '0'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const vulnCount = '${{ steps.safety.outputs.vulnerabilities }}';
            const scanDate = new Date().toISOString();

            // æ—¢å­˜ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£Issueã‚’æ¤œç´¢
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,vulnerability,automated',
              state: 'open'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('é€±æ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³')
            );

            const updateComment = `## ğŸ”„ ã‚¹ã‚­ãƒ£ãƒ³æ›´æ–°\n\n` +
              `**æ¤œå‡ºæ—¥æ™‚**: ${scanDate}\n` +
              `**æ¤œå‡ºä»¶æ•°**: ${vulnCount}ä»¶\n\n` +
              // yamllint disable-next-line rule:line-length
              `è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯[Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚\n\n` +
              `---\n` +
              `âš ï¸ è„†å¼±æ€§ãŒç¶™ç¶šã—ã¦æ¤œå‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚æ—©æ€¥ãªå¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`;

            if (existingIssue) {
              // æ—¢å­˜Issueã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: updateComment
              });
              console.log(`æ—¢å­˜Issue #${existingIssue.number} ã«æ›´æ–°ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
            } else {
              // æ–°è¦Issueä½œæˆ
              let body = `## ğŸš¨ é€±æ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: è„†å¼±æ€§æ¤œå‡º\n\n`;
              body += `**æ¤œå‡ºæ—¥æ™‚**: ${scanDate}\n`;
              body += `**æ¤œå‡ºä»¶æ•°**: ${vulnCount}ä»¶\n\n`;
              body += `### ğŸ“‹ è©³ç´°\n\n`;
              body += `Safetyã‚¹ã‚­ãƒ£ãƒ³ã§${vulnCount}ä»¶ã®æ—¢çŸ¥ã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n\n`;
              // yamllint disable-next-line rule:line-length
              body += `è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯[Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚\n\n`;
              body += `### ğŸ”§ å¯¾å¿œæ‰‹é †\n\n`;
              body += `1. ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèª\n`;
              body += `2. è„†å¼±æ€§ã®ã‚ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°\n`;
              body += `3. æ›´æ–°å¾Œã«å†åº¦ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œ\n`;
              body += `4. å•é¡ŒãŒè§£æ±ºã—ãŸã‚‰ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º\n\n`;
              body += `---\n`;
              body += `ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚è„†å¼±æ€§ãŒè§£æ±ºã•ã‚Œã‚‹ã¾ã§é€±æ¬¡ã§æ›´æ–°ã•ã‚Œã¾ã™ã€‚`;

              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ é€±æ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: ${vulnCount}ä»¶ã®è„†å¼±æ€§æ¤œå‡º`,
                body: body,
                labels: ['security', 'vulnerability', 'automated']
              });
              console.log(`æ–°è¦Issue #${newIssue.data.number} ã‚’ä½œæˆã—ã¾ã—ãŸ`);
            }

  codeql-scan:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python
          queries: security-extended,security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:python/weekly"

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [safety-scan, codeql-scan]
    if: always()

    steps:
      - name: Download Safety report
        uses: actions/download-artifact@v4
        with:
          name: safety-report
        continue-on-error: true

      - name: Generate security summary
        run: |
          echo "# ğŸ”’ é€±æ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ“Š ã‚¹ã‚­ãƒ£ãƒ³çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "safety-report.txt" ]; then
            # yamllint disable-next-line rule:line-length
            VULN_COUNT=$(grep -oP '\d+(?= known security vulnerabilit)' safety-report.txt 2>/dev/null | head -1 || echo "0")
            if [ "$VULN_COUNT" -eq 0 ]; then
              echo "- **Safety**: âœ… è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Safety**: âš ï¸ $VULN_COUNT ä»¶ã®æ—¢çŸ¥ã®è„†å¼±æ€§" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Safety**: âŒ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- **CodeQL**: è©³ç´°ã¯Security ã‚¿ãƒ–ã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ”— ãƒªãƒ³ã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # yamllint disable-next-line rule:line-length
          echo "- [Security ã‚¿ãƒ–](https://github.com/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
          # yamllint disable-next-line rule:line-length
          echo "- [Code scanning alerts](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY

      - name: Close issue if no vulnerabilities
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // è„†å¼±æ€§ãŒãªã„å ´åˆã€æ—¢å­˜Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
            let vulnCount = 0;
            if (fs.existsSync('safety-report.txt')) {
              const report = fs.readFileSync('safety-report.txt', 'utf8');
              const match = report.match(/(\d+) known security vulnerabilit/);
              vulnCount = match ? parseInt(match[1]) : 0;
            }

            if (vulnCount === 0) {
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'security,vulnerability,automated',
                state: 'open'
              });

              const existingIssue = issues.data.find(issue =>
                issue.title.includes('é€±æ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³')
              );

              if (existingIssue) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: `## âœ… è„†å¼±æ€§è§£æ±ºç¢ºèª\n\n` +
                    `**ç¢ºèªæ—¥æ™‚**: ${new Date().toISOString()}\n\n` +
                    `é€±æ¬¡ã‚¹ã‚­ãƒ£ãƒ³ã§è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œãªããªã‚Šã¾ã—ãŸã€‚ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ã€‚\n\n` +
                    `ä»Šå¾Œã‚‚é€±æ¬¡ã‚¹ã‚­ãƒ£ãƒ³ã¯ç¶™ç¶šã•ã‚Œã¾ã™ã€‚`
                });

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  state: 'closed'
                });

                console.log(`Issue #${existingIssue.number} ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸ`);
              }
            }
