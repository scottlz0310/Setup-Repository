# AI開発標準ルール（rules.md）

## 1. 基本方針

### 1.1 言語・コミュニケーション
- AIは日本語で応答し、ドキュメント・コメントも日本語で記述する
- 英語への自動切り替えは禁止

### 1.2 品質原則
- 各モジュール・関数は単一の責務を持つこと（責務分離の徹底）
- 妥協案の提案や手抜き実装は禁止
- エラーは回避ではなく根本解決すること

## 2. プロジェクト構成

### 2.1 ディレクトリ構造
```
project-root/
├── main.py                 # エントリポイント
├── test_entry.py           # テストエントリポイント
├── Makefile                # ビルド・実行スクリプト
├── pyproject.toml          # 設定統合ファイル
├── uv.lock                 # 依存関係ロックファイル
├── .gitignore             # Git除外設定
├── README.md              # プロジェクト説明
├── CHANGELOG.md           # 変更履歴
├── LICENSE                # ライセンス
├── rules.md               # 開発ルール（本ファイル）
├── src/                   # 実装コード
├── tests/                 # テストコード
├── docs/                  # 詳細ドキュメント
├── playground/            # 使用例・実験コード
├── scripts/               # 補助スクリプト
├── tools/                 # 開発ツール
├── assets/                # 素材ファイル
├── output/                # 生成物
└── .cache/                # キャッシュ
```

### 2.2 必須ドキュメント
以下のドキュメントは常に最新状態を保つこと：
- `README.md`: プロジェクト概要・セットアップ・使用方法
- `CHANGELOG.md`: バージョン別変更履歴
- `LICENSE`: ライセンス情報
- `rules.md`: 開発ルール（本ファイル）

### 2.3 Git除外規則
- `.gitignore` には必ず以下のような自動生成系ファイル・ディレクトリを除外対象として追加すること：
  - `__pycache__/`
  - `.venv/`
  - `output/`
  - `.cache/`
  - `*.log`
  - `*.tmp`
  - `*.bak`
- その他スクリプトで自動生成されるファイルも対象とする
- 除外漏れがある場合はCIで警告を出すこと

## 3. 開発環境

### 3.1 仮想環境管理（uv必須）
**基本方針**: `uv`を仮想環境と依存関係管理の標準ツールとして採用

**インストール（推奨）**:
```powershell
# Windows PowerShell
irm https://astral.sh/uv/install.ps1 | iex

# 代替（CI等）
pip install uv
```

**基本ワークフロー**:
```powershell
# 仮想環境作成（.venvに自動作成）
uv venv --python 3.13

# 依存関係管理
uv lock                    # ロックファイル生成
uv sync                    # 環境同期
uv add requests           # パッケージ追加

# 実行
uv run script.py          # 仮想環境で実行
```

**重要な制約**:
- `--system`フラグは開発環境では禁止（CI/コンテナのみ許可）
- ロックファイル（`uv.lock`）は必ずコミット
- CI では`uv sync`による再現性検証必須

### 3.2 設定管理
- `pyproject.toml`に全ての設定を統合
- `requirements.txt`は互換性維持のため自動同期で保持
- `setup.py`等の旧式構成は使用禁止

## 4. コード品質

### 4.1 リンター・フォーマッター
**主要ツール**: `ruff`を中心とした品質管理

**基本コマンド**:
```bash
ruff check .              # リント実行
ruff format .             # フォーマット実行
black .                   # 必要時の最終整形
```

**品質チェック必須項目**:
- `ruff`: リント・フォーマット
- `mypy`: 型チェック
- `pytest`: テスト実行
- T20x: print文検出（debug規約）

### 4.2 スタイルガイド
- **PEP 8準拠**: 基本コーディングスタイル
- **行長制限**: コード88文字、コメント・docstring72文字
- **PEP 257**: Docstring記述規則
- **PEP 484**: 型ヒント必須（`Any`使用時は理由をPRに記載）

## 5. テスト戦略

### 5.1 テスト構成
- **フレームワーク**: pytest
- **配置**: `tests/`ディレクトリ、`test_`プレフィックス
- **カバレッジ目標**: 最終的に80%以上

### 5.2 テストレベル別方針
```
prototype段階:
├── 単体テスト中心
├── mypy緩和設定
└── カバレッジ目標なし

staging段階:
├── 統合テスト追加
├── mypy厳格化
└── カバレッジ60%目標

production段階:
├── E2E・パフォーマンステスト
├── mypy strict
└── カバレッジ80%以上必須
```

### 5.3 テスト品質の絶対ルール
**禁止事項**:
- テスト条件の緩和・簡素化・エラー回避目的のスキップ
- カバレッジ向上目的のダミーテスト
- `assert`なしや常に`True`のテスト
- 無意味な`__str__`, `__repr__`呼び出し

**必須条件**:
- 各テストは実際のバグを発見できる内容
- エラーが出ても根本解決まで継続
- 意味のある検証を含むこと

## 6. セキュリティ・品質保証

### 6.1 セキュリティチェック
- **継続的チェック**: Amazon CodeWhispererによる開発中スキャン
- **包括的監査**: 脆弱性スキャン・ペネトレーションテスト
- **依存関係監査**: CI での SCA（Software Composition Analysis）実行

### 6.2 CI/CD要件
- **マルチプラットフォーム**: Windows・Linux・macOS対応
- **実環境テスト**: モック依存を最小化
- **必須チェック項目**:
  - 依存関係再現性検証
  - セキュリティスキャン
  - 秘密情報検出
  - 全テスト通過確認

## 7. 開発フロー・実装順序

### 7.1 段階的実装フェーズ

#### Phase 1: 計画・設計
- 機能要件・非機能要件の詳細化
- 技術スタック選定・アーキテクチャ設計
- データベース設計・API設計
- 実装計画書を.amazonq/rules/または.kiro/steering/に配置
- **完了条件**: 設計レビューと承認完了

#### Phase 2: 基盤実装  
- 実装計画書に従った開発
- 重要機能の最低限単体テスト実装
- 継続的セキュリティチェック
- README等必須ドキュメント作成
- **完了条件**: 基本機能動作確認と実装レビュー完了

#### Phase 3: 統合・検証
- 全機能要件の動作確認
- UI/UX改良・完全駆動実現
- モジュール責任分離等のリファクタリング
- **完了条件**: 全機能確認と品質レビュー完了

#### Phase 4: 品質保証
- 包括的セキュリティチェック・脆弱性対応
- 完全テストスイート実装（ユニット・統合・E2E・パフォーマンス）
- CI/CDパイプライン構築
- カバレッジ80%以上達成
- **完了条件**: セキュリティレビュー完了

#### Phase 5: デプロイメント準備
- Pre-commitフック実装
- 本番・ステージング環境構築
- 環境固有設定管理
- データベースマイグレーション計画
- **完了条件**: デプロイメント準備完了

#### Phase 6: リリース・運用
- GitHub Actions最終検証
- 段階的デプロイメント
- 監視・メトリクス収集開始
- インシデント対応体制構築
- **完了条件**: 安定運用開始

### 7.2 品質管理体制

#### レビュー体制
- **設計レビュー**: Phase 1完了時
- **実装レビュー**: Phase 2完了時
- **品質レビュー**: Phase 3完了時  
- **セキュリティレビュー**: Phase 4完了時

#### エラーハンドリング原則
- 問題発生時は前段階に戻り根本原因解決
- 重大設計変更時はPhase 1から再開
- 全変更はドキュメント反映・承認必須

## 8. Debug・ログ規約

### 8.1 デバッグ出力規則
- **print関数使用禁止**: loggingモジュール必須
- **ログレベル**: DEBUG・INFO・WARNING・ERROR適切使用
- **T20xチェック**: ruffによる検出必須

### 8.2 一時コード管理
- **命名規則**: `_debug_`プレフィックス必須
- **管理ルール**: PR前に削除またはコメント化・レビュー明示

### 8.3 UI品質の絶対ルール
**禁止事項**:
- デザイン妥協案提案
- 「とりあえず動く」レベル完了報告
- レスポンシブ対応手抜き
- ブラウザ互換性問題放置

## 9. コミット・リリース管理

### 9.1 Pre-commit規約
- 自動修正時は`git commit --amend --no-edit`使用
- 元コミットメッセージ変更禁止
- 自動修正のみの場合: `fix: Pre-commitによる自動修正`

### 9.2 バージョン管理
- バージョン番号整合性をリリースワークフローで検証
- 重要変更（Pythonバージョン・主要パッケージ更新）はPRで明示
- レビュアーはlockfile差分確認必須

### 9.3 継続的改善
- **リリース後監視**: パフォーマンス・エラートラッキング
- **フィードバック収集**: ユーザー利用状況分析
- **次回サイクル**: Phase 1からの改善サイクル繰り返し

## 10. AI作業時の基本姿勢

### 10.1 絶対禁止事項
- 「難しい」「複雑」「時間がかかる」等の弱音
- 失敗による諦め行為
- エラー回避のための妥協案提案

### 10.2 必須姿勢
- エラーは解決すべき課題として扱う
- 根本解決を妥協案より優先
- 継続的改善マインドセット

### 10.3 日付記録規則
- 日付を記述する場合は、必ず `date` コマンド等を使用して実際の日時を取得すること
- 手入力による日付記載は禁止（記録の信頼性を損なうため）
- 例: `date +"%Y-%m-%d %H:%M:%S"` を用いてログやドキュメントに記録

---

**追加機能実装時は Phase 1 からの完全サイクルを繰り返すこと**